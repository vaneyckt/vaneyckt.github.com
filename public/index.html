<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta property="og:title" content="vaneyckt.io" />
<meta property="og:description" content="" />

<meta property="og:type" content="website" />

<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://localhost:1313/" />


  <title> vaneyckt.io </title>

  
  <link href="http://localhost:1313/index.xml" rel="alternate" type="application/rss+xml" title="vaneyckt.io" />
  <link href="http://localhost:1313/index.xml" rel="feed" type="application/rss+xml" title="vaneyckt.io" />
  

  <link rel="stylesheet" href="/css/monokai.css">
  <script src="/js/highlight.pack.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="stylesheet" href="http://localhost:1313//css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313//css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://localhost:1313/index.xml" rel="alternate" type="application/rss+xml" title="vaneyckt.io" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <link href='http://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>

  <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Raleway']
      }
    });
  </script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71853042-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1 class="brand"><a style="text-decoration:none" href="http://localhost:1313/">vaneyckt</a></h1>
      <p class="lead">
         notes to my future self 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://localhost:1313/">Home</a></li>
      <li><a href="http://localhost:1313//posts">Posts</a></li>
      <li><a href="http://localhost:1313//topics">Tags</a></li>
      
      <br/>
      
    </ul>
      
      
      
      <a href="https://github.com/vaneyckt"><i class="fa fa-github-square"></i></a>&nbsp;&nbsp;
      <a href="mailto:tomvaneyck@gmail.com"><i class="fa fa-envelope-square"></i></a>&nbsp;&nbsp;
      <a href="http://vaneyckt.io/index.xml"><i class="fa fa-rss-square"></i></a>&nbsp;&nbsp;
      

    <p class="footnote">powered by <a href="http://hugo.spf13.com">Hugo</a> <br/>
    &copy; 2015 Tom Van Eyck. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/a_javascript_closures_recap/">
        A javascript closures recap
      </a>
    </h1>

    <span class="post-date">Sep 26, 2015</span>

    


    

<p>Javascript closures have always been one those things that I used to navigate by intuition. Recently however, upon stumbling across some code that I did not quite grok, it became clear I should try and obtain a more formal understanding. This post is mainly intended as a quick recap for my future self. It won&rsquo;t go into all the details about closures; instead it will focus on the bits that I found most helpful.</p>

<p>There seem to be very few step-by-step overviews of javascript closures. As a matter of fact, I only found two. Luckily they are both absolute gems. You can find them <a href="http://openhome.cc/eGossip/JavaScript/Closures.html">here</a> and <a href="https://web.archive.org/web/20080209105120/http://blog.morrisjohns.com/javascript_closures_for_dummies">here</a>. I heartily recommend both these articles to anyone wanting to gain a more complete understanding of closures.</p>

<h3 id="closure-basics:fd3eb7d414a05af8a77db8210b1ff256">Closure basics</h3>

<p>I&rsquo;m going to shamelessly borrow a few lines from the <a href="http://openhome.cc/eGossip/JavaScript/Closures.html">first</a> of the two articles linked above to illustrate the basic concept of a closure.</p>

<pre><code class="language-javascript">function doSome() {
  var x = 10;

  function f(y) {
    return x + y;
  }
  return f;
}

var foo = doSome();
foo(20); // returns 30
foo(30); // returns 40
</code></pre>

<blockquote>
<p>In the above example, the function f creates a closure. If you just look at f, it seems that the variable x is not defined. Actually, x is caught from the enclosing function. A closure is a function which closes (or survives) variables of the enclosing function. In the above example, the function f creates a closure because it closes the variable x into the scope of itself. If the closure object, a Function instance, is still alive, the closed variable x keeps alive. It&rsquo;s like that the scope of the variable x is extended.</p>
</blockquote>

<p>This is really all you need to know about closures: they refer to variables declared outside the scope of the function and by doing so keep these variables alive. Closure behavior can be entirely explained just by keeping these two things in mind.</p>

<h3 id="closures-and-primitive-data-types:fd3eb7d414a05af8a77db8210b1ff256">Closures and primitive data types</h3>

<p>The rest of this post will go over some code examples to illustrate the behavior of closures for both primitive and object params. In this section, we&rsquo;ll have a look at the behavior of a closure with a primitive data type param.</p>

<h4 id="example-1:fd3eb7d414a05af8a77db8210b1ff256">Example 1</h4>

<p>The code below will be our starting point for studying closures. Be sure to take a good look at it, as all our examples will be a variation of this code. Throughout this post, we are going to try and understand closures by examining the values returned by the <code>foo()</code> function.</p>

<pre><code class="language-javascript">var prim = 1;

var foo = function(p) {
  var f = function() {
    return p;
  }
  return f;
}(prim);

foo();    // returns 1
prim = 3;
foo();    // returns 1
</code></pre>

<p>When the javascript runtime wants to resolve the value returned by <code>return p;</code>, it finds that this p variable is the same as the p variable from <code>var foo = function(p) {</code>. In other words, there is no direct link between the p from <code>return p;</code> and the variable prim from <code>var prim = 1;</code>. We see this is true because assigning a new value to prim does not cause the value returned by <code>foo()</code> to change.</p>

<h4 id="example-2:fd3eb7d414a05af8a77db8210b1ff256">Example 2</h4>

<p>Now let&rsquo;s have a look at what happens when we make a small change to the previous code sample by adding the line <code>p = 2;</code> to it.</p>

<pre><code class="language-javascript">var prim = 1;

var foo = function(p) {
  var f = function() {
    return p;
  }
  p = 2;
  return f;
}(prim);

foo();    // returns 2
prim = 3;
foo();    // returns 2
</code></pre>

<p>The code above is interesting in that it shows that the p variable from <code>return p;</code> is indeed the same as the p variable from <code>var foo = function(p) {</code>. Even though the variable f gets created at a time when p is set to 1, the act of setting p to 2 does indeed cause the value returned by <code>foo()</code> to change. This is a great example of a closure keeping a closed variable alive.</p>

<h4 id="example-3:fd3eb7d414a05af8a77db8210b1ff256">Example 3</h4>

<p>This sample shows code similar to the first, but this time we made the closure close over the prim variable.</p>

<pre><code class="language-javascript">var prim = 1;

var foo = function() {
  return prim;
}

foo();    // returns 1
prim = 3;
foo();    // returns 3
</code></pre>

<p>Here too we can make a similar deduction as we did for the previous samples. When the javascript runtime wants to resolve the value returned by <code>return prim;</code>, it finds that this prim variable is the same as the prim variable from <code>var prim = 1;</code>. This explains why setting prim to 3 causes the value returned by <code>foo()</code> to change.</p>

<h3 id="closures-and-objects:fd3eb7d414a05af8a77db8210b1ff256">Closures and objects</h3>

<p>In this section we&rsquo;ll see what happens when we take our code samples and change the param from a primitive data type to an object.</p>

<h4 id="example-1-a:fd3eb7d414a05af8a77db8210b1ff256">Example 1.a</h4>

<p>The code below is interesting because in the previous section we saw that a similar example using a primitive param had both calls to <code>foo()</code> return the same value. So what&rsquo;s different here? Let&rsquo;s inspect how the runtime resolves the variables involved.</p>

<pre><code class="language-javascript">var obj = [&quot;a&quot;];

var foo = function(o) {
  var f = function() {
    return o.length;
  }
  return f;
}(obj);

foo();        // returns 1
obj[1] = &quot;b&quot;; // modifies the object pointed to by the obj var
obj[2] = &quot;c&quot;; // modifies the object pointed to by the obj var
foo();        // returns 3
</code></pre>

<p>When the runtime tries to resolve the variable o from <code>return o.length;</code>, it finds that this variable o is the same as the variable o from <code>var foo = function(o) {</code>. We saw this exact same thing in the previous section. Unlike the previous section, the variable o now contains a reference to an array object. This causes our closure to have a direct link to this array object, and thus any changes to it will get reflected in the output of <code>foo()</code>. This explains why the second call to <code>foo()</code> gives a different output than the first.</p>

<p><strong>A good rule of thumb goes like this:</strong></p>

<ul>
<li><strong>if a closed variable contains a value, then the closure links to that variable</strong></li>
<li><strong>if a closed variable contains a reference to an object, then the closure links to that object, and will pick up on any changes made to it</strong></li>
</ul>

<h4 id="example-1-b:fd3eb7d414a05af8a77db8210b1ff256">Example 1.b</h4>

<p>Note that the closure will only pick up on changes made to the particular object that was present when the closure was created. Assigning a new object to the obj variable after the closure was created will have no effect. The code below illustrates this.</p>

<pre><code class="language-javascript">var obj = [&quot;a&quot;];

var foo = function(o) {
  var f = function() {
    return o.length;
  }
  return f;
}(obj);

foo();                 // returns 1
obj = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]; // assign a new array object to the obj variable
foo();                 // returns 1
</code></pre>

<p>In fact, this code is practically identical to the code from Example 1 of the previous section.</p>

<h4 id="example-2-1:fd3eb7d414a05af8a77db8210b1ff256">Example 2</h4>

<p>We&rsquo;ll now modify the previous code sample a bit. This time we&rsquo;ll take a look at what happens when we add the line <code>o[1] = &quot;b&quot;;</code>.</p>

<pre><code class="language-javascript">var obj = [&quot;a&quot;];

var foo = function(o) {
  var f = function() {
    return o.length;
  }
  o[1] = &quot;b&quot;;
  return f;
}(obj);

foo();        // returns 2
obj[1] = &quot;b&quot;;
obj[2] = &quot;c&quot;;
foo();        // returns 3
</code></pre>

<p>Once again, we can start by reasoning about how the runtime resolves the variable o from <code>return o.length;</code>. As you probably know by now, this variable o is the same as the variable o from <code>var foo = function(o) {</code>. And since it contains a reference to an object, any changes to this object will get reflected in the output of <code>foo()</code>. This explains why the first call to <code>foo()</code> now returns 2, whereas previously it was returning 1.</p>

<h4 id="example-3-1:fd3eb7d414a05af8a77db8210b1ff256">Example 3</h4>

<p>If you managed to make it this far, this last bit of code should hold no surprises for you.</p>

<pre><code class="language-javascript">var obj = [&quot;a&quot;];

var foo = function() {
  return obj.length;
}

foo();        // returns 1
obj[1] = &quot;b&quot;;
obj[2] = &quot;c&quot;;
foo();        // returns 3
</code></pre>

<p>The runtime will resolve the variable obj from <code>return obj.length;</code> to be the same as the variable obj from <code>var obj = [&quot;a&quot;];</code>. As a result, any changes to the obj variable will have an effect on the output of <code>foo()</code>.</p>

<h3 id="conclusion:fd3eb7d414a05af8a77db8210b1ff256">Conclusion</h3>

<p>Hopefully this post has demystified closures a bit. Time and time again, we&rsquo;ve shown how following a few simple steps will lead you to understand their behavior. Just keep in mind these rules of thumb and you should be good to go:</p>

<ul>
<li>if a closed variable contains a value, then the closure links to that variable</li>
<li>if a closed variable contains a reference to an object, then the closure links to that object, and will pick up on any changes made to it</li>
</ul>

<p>Ideally, this is going to become my go-to post for providing an introduction to closures. So please let me know any suggestions you might have to improve this post.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/installing_chromedriver/">
        Installing Chromedriver
      </a>
    </h1>

    <span class="post-date">Aug 16, 2015</span>

    


    <p>Some time ago I needed to install <a href="https://sites.google.com/a/chromium.org/chromedriver/">chromedriver</a> on a ubuntu machine. While this wasn&rsquo;t too hard, I was nevertheless surprised by the number of open StackOverflow questions on this topic. So I decided to leave some notes for my future self.</p>

<p>First of all, let&rsquo;s install chromedriver.</p>

<pre><code class="language-bash">$ LATEST_RELEASE=$(curl http://chromedriver.storage.googleapis.com/LATEST_RELEASE)
$ wget http://chromedriver.storage.googleapis.com/$LATEST_RELEASE/chromedriver_linux64.zip
$ unzip chromedriver_linux64.zip
$ rm chromedriver_linux64.zip
$ sudo mv chromedriver /usr/local/bin
</code></pre>

<p>Let&rsquo;s see what happens when we try and run it.</p>

<pre><code class="language-bash">$ chromedriver

chromedriver: error while loading shared libraries: libgconf-2.so.4:
cannot open shared object file: No such file or directory
</code></pre>

<p>That&rsquo;s a bit unexpected. Luckily we can easily fix this.</p>

<pre><code class="language-bash">$ sudo apt-get install libgconf-2-4
</code></pre>

<p>Now that we have a functioning chromedriver, the only thing left to do is to install Chrome. After all, chromedriver can&rsquo;t function without Chrome.</p>

<pre><code class="language-bash">$ wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
$ sudo sh -c 'echo &quot;deb http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list'
$ sudo apt-get update
$ sudo apt-get install google-chrome-stable
</code></pre>

<p>And that&rsquo;s it. You should be good to go now.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/creating_an_ec2_instance_in_a_vpc_with_the_aws_cli/">
        Creating an EC2 Instance in a VPC with the AWS CLI
      </a>
    </h1>

    <span class="post-date">Oct 29, 2014</span>

    


    

<p>Setting up an EC2 instance on AWS used to be as straightforward as provisioning a machine and SSHing into it. However, this process has become a bit more complicated now that Amazon VPC has become the standard for managing machines in the cloud.</p>

<p>So what exactly is a Virtual Private Cloud? Amazon defines a VPC as &lsquo;a logically isolated section of the AWS Cloud&rsquo;. Instances inside a VPC can by default only communicate with other instances in the same VPC and are therefore invisible to the rest of the internet. This means they will not accept SSH connections coming from your computer, nor will they respond to any http requests. In this article we&rsquo;ll look into changing these default settings into something more befitting a general purpose server.</p>

<h3 id="setting-up-your-vpc:ed16f33dbf5018a09918ad8ef3c5f741">Setting up your VPC</h3>

<p>Start by installing the <a href="http://aws.amazon.com/cli">AWS Command Line Interface</a> on your machine if you haven&rsquo;t done so already. With this done, we can now create our VPC.</p>

<pre><code class="language-bash">$ vpcId=`aws ec2 create-vpc --cidr-block 10.0.0.0/28 --query 'Vpc.VpcId' --output text`
</code></pre>

<p>There are several interesting things here:</p>

<ul>
<li>the <code>--cidr-block</code> parameter specifies a /28 netmask that allows for 16 IP addresses. This is the smallest supported netmask.</li>
<li>the <code>create-vpc</code> command returns a JSON string. We can filter out specific fields from this string by using the <code>--query</code> and <code>--output</code> parameters.</li>
</ul>

<p>The next step is to overwrite the default VPC DNS settings. As mentioned earlier, instances launched inside a VPC are invisible to the rest of the internet by default. AWS therefore does not bother assigning them a public DNS name. Luckily this can be changed easily.</p>

<pre><code class="language-bash">$ aws ec2 modify-vpc-attribute --vpc-id $vpcId --enable-dns-support &quot;{\&quot;Value\&quot;:true}&quot;
$ aws ec2 modify-vpc-attribute --vpc-id $vpcId --enable-dns-hostnames &quot;{\&quot;Value\&quot;:true}&quot;
</code></pre>

<h3 id="adding-an-internet-gateway:ed16f33dbf5018a09918ad8ef3c5f741">Adding an Internet Gateway</h3>

<p>Next we need to connect our VPC to the rest of the internet by attaching an internet gateway. Our VPC would be isolated from the internet without this.</p>

<pre><code class="language-bash">$ internetGatewayId=`aws ec2 create-internet-gateway --query 'InternetGateway.InternetGatewayId' --output text`
$ aws ec2 attach-internet-gateway --internet-gateway-id $internetGatewayId --vpc-id $vpcId
</code></pre>

<h3 id="creating-a-subnet:ed16f33dbf5018a09918ad8ef3c5f741">Creating a Subnet</h3>

<p>A VPC can have multiple subnets. Since our use case only requires one, we can reuse the cidr-block specified during VPC creation so as to get a single subnet that spans the entire VPC address space.</p>

<pre><code class="language-bash">$ subnetId=`aws ec2 create-subnet --vpc-id $vpcId --cidr-block 10.0.0.0/28 --query 'Subnet.SubnetId' --output text`
</code></pre>

<p>While this <code>--cidr-block</code> parameter specifies a subnet that can contain 16 IP addresses (10.0.0.1 - 10.0.0.16), AWS will reserve 5 of those for private use. While this doesn&rsquo;t really have an impact on our use case, it is still good to be aware of such things.</p>

<h3 id="configuring-the-route-table:ed16f33dbf5018a09918ad8ef3c5f741">Configuring the Route Table</h3>

<p>Each subnet needs to have a route table associated with it to specify the routing of its outbound traffic. By default every subnet inherits the default VPC route table which allows for intra-VPC communication only.</p>

<p>Here we add a route table to our subnet so as to allow traffic not meant for an instance inside the VPC to be routed to the internet through the internet gateway we created earlier.</p>

<pre><code class="language-bash">$ routeTableId=`aws ec2 create-route-table --vpc-id $vpcId --query 'RouteTable.RouteTableId' --output text`
$ aws ec2 associate-route-table --route-table-id $routeTableId --subnet-id $subnetId
$ aws ec2 create-route --route-table-id $routeTableId --destination-cidr-block 0.0.0.0/0 --gateway-id $internetGatewayId
</code></pre>

<h3 id="adding-a-security-group:ed16f33dbf5018a09918ad8ef3c5f741">Adding a Security Group</h3>

<p>Before we can launch an instance, we first need to create a security group that specifies which ports should allow traffic. For now we&rsquo;ll just allow anyone to try and make an SSH connection by opening port 22 to any IP address.</p>

<pre><code class="language-bash">$ securityGroupId=`aws ec2 create-security-group --group-name my-security-group --description &quot;my-security-group&quot; --vpc-id $vpcId --query 'GroupId' --output text`
$ aws ec2 authorize-security-group-ingress --group-id $securityGroupId --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre>

<h3 id="launching-your-instance:ed16f33dbf5018a09918ad8ef3c5f741">Launching your Instance</h3>

<p>All that&rsquo;s left to do is to create an SSH key pair and then launch an instance secured by this. Let&rsquo;s generate this key pair and store it locally with the correct permissions.</p>

<pre><code class="language-bash">$ aws ec2 create-key-pair --key-name my-key --query 'KeyMaterial' --output text &gt; ~/.ssh/my-key.pem
$ chmod 400 ~/.ssh/my-key.pem
</code></pre>

<p>We can now launch a single t2.micro instance based on the public AWS Ubuntu image.</p>

<pre><code class="language-bash">$ instanceId=`aws ec2 run-instances --image-id ami-9eaa1cf6 --count 1 --instance-type t2.micro --key-name my-key --security-group-ids $securityGroupId --subnet-id $subnetId --associate-public-ip-address --query 'Instances[0].InstanceId' --output text`
</code></pre>

<p>After a few minutes your instance should be up and running. You should now be able to obtain the url of your active instance and SSH into it.</p>

<pre><code class="language-bash">$ instanceUrl=`aws ec2 describe-instances --instance-ids $instanceId --query 'Reservations[0].Instances[0].PublicDnsName' --output text`
$ ssh -i ~/.ssh/my-key.pem ubuntu@$instanceUrl
</code></pre>

<p>And that&rsquo;s it. It&rsquo;s really not all that hard. There&rsquo;s just an awful lot of concepts that you need to get your head around which can make it a bit daunting at first. Be sure to check out the free <a href="http://www.amazon.com/gp/product/B007S33NT2/ref=cm_cr_ryp_prd_ttl_sol_0">Amazon Virtual Private Cloud User Guide</a> if you want to learn more about VPCs.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/adding_a_post_execution_hook_to_the_db_migrate_task/">
        Adding a post-execution hook to the db:migrate task
      </a>
    </h1>

    <span class="post-date">Jun 9, 2014</span>

    


    <p>A few days ago we discovered that our MySQL database&rsquo;s default character set and collation had been changed to the wrong values. Worse yet, it looked like this change had happened many months ago; something which we had been completely unaware of until now! In order to make sure this didn&rsquo;t happen again, we looked into adding a post-execution hook to the rails db:migrate task.</p>

<p>Our first attempt is shown below. Here, we append a post-execution hook to the existing db:migrate task by creating a new db:migrate task. In rake, when a task is defined twice, the behavior of the new task gets appended to the behavior of the old task. So even though the code below may give the impression of overwriting the rails db:migrate task, we are actually just appending a call to the <code>post_execution_hook</code> method to it.</p>

<pre><code class="language-ruby">namespace :db do
  def post_execution_hook
    puts 'This code gets run after the rails db:migrate task.'
    puts 'However, it only runs if the db:migrate task does not throw an exception.'
  end

  task :migrate do
    post_execution_hook
  end
end
</code></pre>

<p>However, the above example only runs the appended code if the original db:migrate task does not throw any exceptions. Luckily we can do better than that by taking a slightly different approach. Rather than appending code, we are going to have a go at prepending it instead.</p>

<pre><code class="language-ruby">namespace :db do
  def post_execution_hook
    puts 'This code gets run after the rails db:migrate task.'
    puts 'It will ALWAYS run.'
  end

  task :attach_hook do
    at_exit { post_execution_hook }
  end
end

Rake::Task['db:migrate'].enhance(['db:attach_hook'])
</code></pre>

<p>Here we make use of the <a href="http://ruby-doc.org/stdlib-2.0.0/libdoc/rake/rdoc/Rake/Task.html#method-i-enhance">enhance method</a> to add db:attach_hook as a prerequisite task to db:migrate. This means that calling db:migrate will now cause the db:attach_hook task to get executed before db:migrate gets run. The db:attach_hook task creates an <code>at_exit</code> hook that will trigger our post-execution code upon exit of the db:migrate task. Hence, our post-execution hook will now get called even when db:migrate raises an exception!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/safer_bash_scripts_with_set_euxo_pipefail/">
        Safer bash scripts with &#39;set -euxo pipefail&#39;
      </a>
    </h1>

    <span class="post-date">May 14, 2014</span>

    


    

<p>Often times developers go about writing bash scripts the same as writing code in a higher-level language. This is a big mistake as higher-level languages offer safeguards that are not present in bash scripts by default. For example, a Ruby script will throw an error when trying to read from an uninitialized variable, whereas a bash script won&rsquo;t. In this article we&rsquo;ll look at how we can improve on this.</p>

<p>The bash shell comes with several builtin commands for modifying the behavior of the shell itself. We are particularly interested in the <a href="https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html">set builtin</a>, as this command has several options that will help us write safer scripts. I hope to convince you that it&rsquo;s a really good idea to add <code>set -euxo pipefail</code> to the start of all your future bash scripts.</p>

<h3 id="set-e:d0406b09675b080255aad6f1a20a9332">set -e</h3>

<p>The <code>-e</code> option will cause a bash script to exit immediately when a command fails. This is generally a vast improvement upon the default behavior where the script just ignores the failing command and continues with the next line. This option is also smart enough to not react on failing commands that are part of conditional statements. Moreover, you can append a command with <code>|| true</code> for those rare cases where you don&rsquo;t want a failing command to trigger an immediate exit.</p>

<h4 id="before:d0406b09675b080255aad6f1a20a9332">Before</h4>

<pre><code class="language-bash">#!/bin/bash

# 'foo' is a non-existing command
foo
echo &quot;bar&quot;

# output
# ------
# line 4: foo: command not found
# bar
</code></pre>

<h4 id="after:d0406b09675b080255aad6f1a20a9332">After</h4>

<pre><code class="language-bash">#!/bin/bash
set -e

# 'foo' is a non-existing command
foo
echo &quot;bar&quot;

# output
# ------
# line 5: foo: command not found
</code></pre>

<h4 id="prevent-immediate-exit:d0406b09675b080255aad6f1a20a9332">Prevent immediate exit</h4>

<pre><code class="language-bash">#!/bin/bash
set -e

# 'foo' is a non-existing command
foo || true
echo &quot;bar&quot;

# output
# ------
# line 5: foo: command not found
# bar
</code></pre>

<h3 id="set-o-pipefail:d0406b09675b080255aad6f1a20a9332">set -o pipefail</h3>

<p>The bash shell normally only looks at the exit code of the last command of a pipeline. This behavior is not ideal as it causes the <code>-e</code> option to only be able to act on the exit code of a pipeline&rsquo;s last command. This is where <code>-o pipefail</code> comes in. This particular option sets the exit code of a pipeline to that of the rightmost command to exit with a non-zero status, or zero if all commands in the pipeline exit successfully.</p>

<h4 id="before-1:d0406b09675b080255aad6f1a20a9332">Before</h4>

<pre><code class="language-bash">#!/bin/bash
set -e

# 'foo' is a non-existing command
foo | echo &quot;a&quot;
echo &quot;bar&quot;

# output
# ------
# a
# line 5: foo: command not found
# bar
</code></pre>

<h4 id="after-1:d0406b09675b080255aad6f1a20a9332">After</h4>

<pre><code class="language-bash">#!/bin/bash
set -eo pipefail

# 'foo' is a non-existing command
foo | echo &quot;a&quot;
echo &quot;bar&quot;

# output
# ------
# a
# line 5: foo: command not found
</code></pre>

<h3 id="set-u:d0406b09675b080255aad6f1a20a9332">set -u</h3>

<p>This option causes the bash shell to treat unset variables as an error and exit immediately.</p>

<h4 id="before-2:d0406b09675b080255aad6f1a20a9332">Before</h4>

<pre><code class="language-bash">#!/bin/bash
set -eo pipefail

# 'foo' is a non-existing command
echo $a
echo &quot;bar&quot;

# output
# ------
#
# bar
</code></pre>

<h4 id="after-2:d0406b09675b080255aad6f1a20a9332">After</h4>

<pre><code class="language-bash">#!/bin/bash
set -euo pipefail

# 'foo' is a non-existing command
echo $a
echo &quot;bar&quot;

# output
# ------
# line 5: a: unbound variable
</code></pre>

<h3 id="set-x:d0406b09675b080255aad6f1a20a9332">set -x</h3>

<p>The <code>-x</code> option causes bash to print each command before executing it. This can be of great help when you have to try and debug a bash script failure through its logs. Note that arguments get expanded before a command gets printed. This causes our logs to display the actual argument values at the time of execution!</p>

<pre><code class="language-bash">#!/bin/bash
set -euxo pipefail

a=5
echo $a
echo &quot;bar&quot;

# output
# ------
# + a=5
# + echo 5
# 5
# + echo bar
# bar

</code></pre>

<p>I hope this post showed you why using <code>set -euxo pipefail</code> is such a good idea. If you have any other options you want to suggest, then please get in touch.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/programmatically_rotating_the_android_screen/">
        Programmatically rotating the Android screen
      </a>
    </h1>

    <span class="post-date">Mar 20, 2014</span>

    


    <p>A lot of digital ink has been spilled on this subject, so I figured it might be worth to briefly talk about this. You can either change the orientation through ADB or through an app. While the ADB approach is the easiest, it might not work on all devices or on all Android versions. For example, the <code>dumpsys</code> output of a Kindle Fire is different than that of a Samsung Galaxy S4, so you might need to tweak the grepping of the output.</p>

<pre><code class="language-bash"># get current orientation
adb shell dumpsys input | grep SurfaceOrientation | awk '{print $2}'

# change orientaton to portait
adb shell content insert --uri content://settings/system --bind name:s:accelerometer_rotation --bind value:i:0
adb shell content insert --uri content://settings/system --bind name:s:user_rotation --bind value:i:0

# change orientation to landscape
adb shell content insert --uri content://settings/system --bind name:s:accelerometer_rotation --bind value:i:0
adb shell content insert --uri content://settings/system --bind name:s:user_rotation --bind value:i:1
</code></pre>

<p>If you don’t want to use ADB and prefer to change the orientation through an Android app instead, then you can just use these commands.</p>

<pre><code class="language-java">// get current orientation
final int orientation = myActivity.getResources().getConfiguration().orientation;

// change orientation to portrait
myActivity.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);

// change orientation to landscape
myActivity.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/programmatically_creating_android_touch_events/">
        Programmatically creating Android touch events
      </a>
    </h1>

    <span class="post-date">Mar 4, 2014</span>

    


    <p>Recent versions of Android have the <code>adb shell input touch</code> functionality to simulate touch events on an Android device or simulator. However, older Android versions (like 2.3) do not support this command. Luckily it is possible to recreate this functionality by running <code>adb shell getevent</code> to capture events as they are being generated. These events can then later be replayed using the <code>adb shell sendevent</code> command.</p>

<p>Running <code>adb shell getevent</code> when touching the screen might get you something like shown below. Notice how the output is in hexadecimal.</p>

<pre><code class="language-bash">/dev/input/event7: 0001 014a 00000001
/dev/input/event7: 0003 003a 00000001
/dev/input/event7: 0003 0035 000001ce
/dev/input/event7: 0003 0036 00000382
/dev/input/event7: 0000 0002 00000000
/dev/input/event7: 0000 0000 00000000
/dev/input/event7: 0001 014a 00000000
/dev/input/event7: 0003 003a 00000000
/dev/input/event7: 0003 0035 000001ce
/dev/input/event7: 0003 0036 00000382
/dev/input/event7: 0000 0002 00000000
/dev/input/event7: 0000 0000 00000000
</code></pre>

<p>However, the <code>adb shell sendevent</code> command expect all of its input to be in decimal. So if we wanted to replay the above events, we&rsquo;d need to do something like shown below. Note that 462 and 898 are the x and y coordinates of this particular touch event.</p>

<pre><code class="language-bash">adb shell sendevent /dev/input/event7: 1 330 1
adb shell sendevent /dev/input/event7: 3 58 1
adb shell sendevent /dev/input/event7: 3 53 462
adb shell sendevent /dev/input/event7: 3 54 898
adb shell sendevent /dev/input/event7: 0 2 0
adb shell sendevent /dev/input/event7: 0 0 0
adb shell sendevent /dev/input/event7: 1 330 0
adb shell sendevent /dev/input/event7: 3 58 0
adb shell sendevent /dev/input/event7: 3 53 462
adb shell sendevent /dev/input/event7: 3 54 898
adb shell sendevent /dev/input/event7: 0 2 0
adb shell sendevent /dev/input/event7: 0 0 0
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/some_lesser_known_github_api_functionality/">
        Some lesser known Github API functionality
      </a>
    </h1>

    <span class="post-date">Feb 8, 2014</span>

    


    

<p>One of our automation tools occasionally needs to interact with our Github repositories. Unfortunately, the current implementation of this tool leaves something to be desired as it requires cloning these repositories to local disk. Changes against these local repositories are then made on local branches, after which these branches get pushed to Github.</p>

<p>However, in order to save on disk space this tool will only ever create a single local copy of each repository. This makes it unsafe to run multiple instances of this tool as multiple instances simultaneously executing sequences of git commands against the same local repositories might lead to these commands inadvertently getting interpolated, thereby leaving the local repositories in an undefined state.</p>

<p>The solution to this complexity was to completely remove the need for local repositories and instead aim to have everything done through the wonderful Github API. This article is a reminder to myself about some API functionality that I found while looking into this.</p>

<h3 id="checking-if-a-branch-contains-a-commit:ebeddf967e2b970d374ec29d22d794b8">Checking if a branch contains a commit</h3>

<p>While the Github API does not have an explicit call to check whether a given commit is included in a branch, we can nevertheless use the <a href="https://developer.github.com/v3/repos/commits/#compare-two-commits">compare call</a> for just this purpose. This call takes two commits as input and returns a large JSON response of comparison data. We can use the <code>status</code> field of the response to ascertain if a given commit is behind or identical to the HEAD commit of a branch. If so, then the branch contains that commit.</p>

<p>We can use the <a href="https://github.com/octokit/octokit.rb">Ruby octokit gem</a> to implement this as follows.</p>

<pre><code class="language-ruby">require 'octokit'

class GithubClient &lt; Octokit::Client
  def branch_contains_sha?(repo, branch, sha)
    ['behind', 'identical'].include?(compare(repo, branch, sha).status)
  end
end
</code></pre>

<h3 id="creating-a-remote-branch-from-a-remote-commit:ebeddf967e2b970d374ec29d22d794b8">Creating a remote branch from a remote commit</h3>

<p>Sometimes you&rsquo;ll want to create a remote branch by branching from a remote commit. We can use the <a href="https://developer.github.com/v3/git/refs/#create-a-reference">create_reference call</a> to accomplish this. Note that the <code>ref</code> parameter of this call needs to be set to <code>refs/heads/#{branch}</code> when creating a remote branch.</p>

<pre><code class="language-ruby">require 'octokit'

class GithubClient &lt; Octokit::Client
  def create_branch_from_sha(repo, branch, sha)
    # create_ref internally transforms &quot;heads/#{branch}&quot; into &quot;refs/heads/#{branch}&quot;
    # as mentioned above, this is required by the Github API
    create_ref(repo, &quot;heads/#{branch}&quot;, sha)
  end
end
</code></pre>

<h3 id="setting-the-head-of-a-remote-branch-to-a-specific-remote-commit:ebeddf967e2b970d374ec29d22d794b8">Setting the HEAD of a remote branch to a specific remote commit</h3>

<p>You can even forcefully set the HEAD of a remote branch to a specific remote commit by using the <a href="https://developer.github.com/v3/git/refs/#update-a-reference">update_reference call</a>. As mentioned earlier, the <code>ref</code> parameter needs to be set to <code>refs/heads/#{branch}</code>. Be careful when using this functionality though as it essentially allows you to overwrite the history of a remote branch!</p>

<pre><code class="language-ruby">require 'octokit'

class GithubClient &lt; Octokit::Client
  def update_branch_to_sha(repo, branch, sha, force = true)
    # update_ref internally transforms &quot;heads/#{branch}&quot; into &quot;refs/heads/#{branch}&quot;
    # as mentioned earlier, this is required by the Github API
    update_ref(repo, &quot;heads/#{branch}&quot;, sha, force)
  end
end
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/the_amazing_bitwise_xor_operator/">
        The amazing bitwise XOR operator
      </a>
    </h1>

    <span class="post-date">Jan 12, 2014</span>

    


    

<p>One of my colleagues recently mentioned this interview question to me.</p>

<blockquote>
<p>Imagine there is an array which contains 2n+1 elements, n of which have exactly one duplicate. Can you find the one unique element in this array?</p>
</blockquote>

<p>This seemed simple enough and I quickly came up with the Ruby solution below.</p>

<pre><code class="language-ruby">&gt; array = [3, 5, 4, 5, 3]
# =&gt; [3, 5, 4, 5, 3]
&gt; count = array.each_with_object(Hash.new(0)) { |number, hash| hash[number] += 1 }
# =&gt; {3=&gt;2, 5=&gt;2, 4=&gt;1}
&gt; count.key(1)
# =&gt; 4
</code></pre>

<p>I thought that would be the end of it, but instead I was asked if I could see a way to solve the problem in a significantly more performant way using the XOR operator.</p>

<h3 id="xor-characteristics:3b1479834de8b2716c6d36848e7cf887">XOR characteristics</h3>

<p>In order to solve this problem with the XOR operator, we first need to understand some of its characteristics. This operator obeys the following rules:</p>

<ul>
<li>commutativity: <code>A^B=B^A</code></li>
<li>associativity: <code>(A^B)^C=A^(B^C)</code></li>
<li>the identity element is 0: <code>A^0=A</code></li>
<li>each element is its own inverse: <code>A^A=0</code></li>
</ul>

<p>Now imagine an array with the elements <code>[3, 5, 4, 5, 3]</code>. Using the above rules, we can show that XORing all these elements will leave us with the array&rsquo;s unique element.</p>

<pre><code class="language-ruby">accum = 3 ^ 5 ^ 4 ^ 5 ^ 3
accum = 0 ^ 3 ^ 5 ^ 4 ^ 5 ^ 3    # 0 is the identity element
accum = 0 ^ 3 ^ 3 ^ 4 ^ 5 ^ 5    # commutativity and associativity rules
accum = 0 ^ 0 ^ 4 ^ 0            # A^A = 0
accum = 4                        # 0 is the identity element
</code></pre>

<p>Putting this approach in code would give us something like this.</p>

<pre><code class="language-ruby">&gt; array = [3, 5, 4, 5, 3]
# =&gt; [3, 5, 4, 5, 3]
&gt; accum = 0
# =&gt; 0
&gt; array.each { |number| accum = accum ^ number }
# =&gt; [3, 5, 4, 5, 3]
&gt; accum
# =&gt; 4
</code></pre>

<h3 id="benchmarks:3b1479834de8b2716c6d36848e7cf887">Benchmarks</h3>

<p>Let&rsquo;s use Ruby&rsquo;s <code>Benchmark</code> module to do a comparison of both approaches.</p>

<pre><code class="language-ruby">require 'benchmark'

array = [-1]
1000000.times do |t|
  array &lt;&lt; t
  array &lt;&lt; t
end

Benchmark.measure do
  count = array.each_with_object(Hash.new(0)) { |number, hash| hash[number] += 1 }
  count.key(1)
end
# =&gt; #&lt;Benchmark::Tms:0x007f83fa0279e0 @label=&quot;&quot;, @real=0.83534, @cstime=0.0, @cutime=0.0, @stime=0.010000000000000009, @utime=0.8300000000000005, @total=0.8400000000000005&gt;

Benchmark.measure do
  accum = 0
  array.each { |number| accum = accum ^ number }
  accum
end
# =&gt; #&lt;Benchmark::Tms:0x007f83fa240ba0 @label=&quot;&quot;, @real=0.136726, @cstime=0.0, @cutime=0.0, @stime=0.0, @utime=0.13999999999999968, @total=0.13999999999999968&gt;
</code></pre>

<p>So there you have it. Given an array that contains two million elements, the XOR operator approach turns out to be more than 6 times faster than utilizing a hashmap. That&rsquo;s quite a nice performance improvement!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/a_visual_explanation_of_sql_joins/">
        A visual explanation of SQL joins
      </a>
    </h1>

    <span class="post-date">Nov 17, 2013</span>

    


    <p>I admit that I find myself going to <a href="http://blog.codinghorror.com/a-visual-explanation-of-sql-joins/">this article</a> every time I need to write some joins. Hopefully putting it here will save me from always having to google it.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/check_the_order_of_your_rescue_from_handlers/">
        Check the order of your rescue_from handlers!
      </a>
    </h1>

    <span class="post-date">Nov 11, 2013</span>

    


    <p>Our <code>rescue_from</code> handlers used to be defined like shown below. This might look okay to you. At first glance everything looks fine, right?</p>

<pre><code class="language-ruby">class WidgetsController &lt; ActionController::Base
  rescue_from ActionController::RoutingError, :with =&gt; :render_404
  rescue_from Exception,                      :with =&gt; :render_500
end
</code></pre>

<p>Turns out it&rsquo;s not okay at all. Handlers are searched <a href="http://apidock.com/rails/ActiveSupport/Rescuable/ClassMethods/rescue_from">from bottom to top</a>. This means that they should always be defined in order of most generic to most specific. Or in other words, the above code is exactly the wrong thing to do. Instead, we need to write our handlers like shown here.</p>

<pre><code class="language-ruby">class WidgetsController &lt; ActionController::Base
  rescue_from Exception,                      :with =&gt; :render_500
  rescue_from ActionController::RoutingError, :with =&gt; :render_404
end
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/the_javascript_event_loop/">
        The javascript event loop
      </a>
    </h1>

    <span class="post-date">Nov 10, 2013</span>

    


    <p>Sometimes you come across an article that is so well written you can&rsquo;t do anything but link to it. So if you&rsquo;ve ever wondered why the javascript runtime is so good at asynchronous operations, then you should definitely give <a href="http://blog.carbonfive.com/2013/10/27/the-javascript-event-loop-explained/">this article</a> a read.</p>

<p>Some snippets:</p>

<blockquote>
<p>JavaScript runtimes contain a message queue which stores a list of messages to be processed and their associated callback functions. These messages are queued in response to external events (such as a mouse being clicked or receiving the response to an HTTP request) given a callback function has been provided. If, for example a user were to click a button and no callback function was provided – no message would have been enqueued.</p>

<p>In a loop, the queue is polled for the next message (each poll referred to as a “tick”) and when a message is encountered, the callback for that message is executed.</p>

<p>The calling of this callback function serves as the initial frame in the call stack, and due to JavaScript being single-threaded, further message polling and processing is halted pending the return of all calls on the stack.</p>
</blockquote>

<p>As well as:</p>

<blockquote>
<p>Using Web Workers enables you to offload an expensive operation to a separate thread of execution, freeing up the main thread to do other things. The worker includes a separate message queue, event loop, and memory space independent from the original thread that instantiated it. Communication between the worker and the main thread is done via message passing, which looks very much like the traditional, evented code-examples we’ve already seen.</p>
</blockquote>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/bug_hunting_with_git_bisect/">
        Bug hunting with git bisect
      </a>
    </h1>

    <span class="post-date">Nov 4, 2013</span>

    


    <p>Today I was looking into what I thought was going to be a simple bug. The problem seemed straightforward enough, so I did a quick grep of the codebase, found three pieces of code that looked like likely culprits, made some modifications, triggered the bug, and found that absolutely nothing had changed. Half an hour and a lot of additional digging later I was stumped. I had no idea what was going on.</p>

<p>It was at this point that I remembered <code>git bisect</code>. This git command asks you to specify two commits: one where things are working, and another one where things are broken. It then does a binary search across the range of commits in between these two. Each search step asks you whether the current commit contains broken code or not, after which it automatically selects the next commit for you. There&rsquo;s a great tutorial over <a href="http://webchick.net/node/99">here</a>.</p>

<pre><code class="language-bash">$ git bisect start
$ git bisect good rj6y4j3
$ git bisect bad 2q7f529
</code></pre>

<p>It took me all of five minutes to discover the source of the bug this way. I can safely say that it would have taken me ages to track down this particular bit of offending code as it was located in a custom bug fix for a popular third party library (I&rsquo;m looking at you <a href="https://github.com/getsentry/raven-ruby">Sentry</a>).</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/why_is_mysql_converting_my_nulls_to_blanks/">
        Why is MySQL converting my NULLs to blanks?
      </a>
    </h1>

    <span class="post-date">Nov 1, 2013</span>

    


    <p>A while ago I ran into an issue where some records were showing a blank value in a given column. This was a bit weird as a blank value had never been written to that column. After a bit of searching we found that we had a bug that had inadvertently been writing the occasional NULL value to that particular column though. So how did those NULLs get turned into blanks?</p>

<p>It turns out that MySQL can operate in different <a href="https://dev.mysql.com/doc/refman/5.0/en/sql-mode.html">server modes</a>. You can check your server mode by running one of the two commands below. Note that your server mode will be blank by default.</p>

<pre><code class="language-bash">SHOW GLOBAL VARIABLES where Variable_name = 'sql_mode';
SHOW SESSION VARIABLES where Variable_name = 'sql_mode'
</code></pre>

<p>Now that we know about server modes we can talk about <a href="https://dev.mysql.com/doc/refman/5.0/en/data-type-defaults.html">data type defaults</a>. Basically, each MySQL column has an implicit default value assigned to it. Under certain circumstances this default value might be used instead of the value you were expecting.</p>

<blockquote>
<p>As of MySQL 5.0.2, if a column definition includes no explicit DEFAULT value, MySQL determines the default value as follows:</p>

<p>If the column can take NULL as a value, the column is defined with an explicit DEFAULT NULL clause. This is the same as before 5.0.2.</p>

<p>If the column cannot take NULL as the value, MySQL defines the column with no explicit DEFAULT clause. Exception: If the column is defined as part of a PRIMARY KEY but not explicitly as NOT NULL, MySQL creates it as a NOT NULL column (because PRIMARY KEY columns must be NOT NULL), but also assigns it a DEFAULT clause using the implicit default value. To prevent this, include an explicit NOT NULL in the definition of any PRIMARY KEY column.</p>

<p>For data entry into a NOT NULL column that has no explicit DEFAULT clause, if an INSERT or REPLACE statement includes no value for the column, or an UPDATE statement sets the column to NULL, MySQL handles the column according to the SQL mode in effect at the time:</p>

<ul>
<li><em>If strict SQL mode is enabled, an error occurs for transactional tables and the statement is rolled back. For nontransactional tables, an error occurs, but if this happens for the second or subsequent row of a multiple-row statement, the preceding rows will have been inserted.</em></li>
<li><em>If strict mode is not enabled, MySQL sets the column to the implicit default value for the column data type.</em></li>
</ul>
</blockquote>

<p>We found that our code was sometimes writing NULLs to a NOT NULL column on a server that was not running in strict mode. This in turn caused our NULLs to silently get changed to blanks as this was the column default value. Mystery solved.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/using_environment_variables_in_migrations/">
        Using environment variables in migrations
      </a>
    </h1>

    <span class="post-date">Oct 29, 2013</span>

    


    <p>Recently we had to run a migration that was so slow we couldn&rsquo;t afford the downtime it would cause. In order to get around this, it was decided to put two code paths in the migration: one that was slow and thorough, and one that was quick but didn&rsquo;t perform any safety checks.</p>

<p>The first path would be run on a recent database dump, whereas the latter would be executed directly on the live database once the first had finished without error. This was a lot less crazy than it might sound as the particular table under modification had very infrequent changes.</p>

<p>It was decided to use environment variables to allow for easy switching between code paths. This is what the code ended up looking like.</p>

<pre><code class="language-ruby">class MyDangerousMigration &lt; ActiveRecord::Migration
  def change
    if ENV['skip_checks'] == 'true'
      # code without safety checks
    else
      # code with safety checks
    end
  end
end
</code></pre>

<p>This could then be run like so.</p>

<pre><code class="language-bash">skip_checks=true bundle exec rake db:migrate
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/getting_connection_information_with_lsof/">
        Getting connection information with lsof
      </a>
    </h1>

    <span class="post-date">Oct 21, 2013</span>

    


    

<p>The <a href="http://linux.die.net/man/8/lsof">lsof command</a> is one of those super useful commands for figuring out what connections are taking place on your machine. While the <code>lsof</code> command technically just lists open files, just about everything in linux (even sockets) is a file!</p>

<p>Some useful commands:</p>

<h4 id="list-all-network-connections:af3807b2c0cfda8f5c0a92778b96cb1b">List all network connections</h4>

<pre><code class="language-bash">$ lsof -i

COMMAND     PID     USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Spotify   36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
Spotify   36908 vaneyckt   54u  IPv4 0x2097c8deab18027d      0t0  TCP localhost:4371 (LISTEN)
Spotify   36908 vaneyckt   71u  IPv4 0x2097c8deba747c1d      0t0  UDP *:57621
Spotify   36908 vaneyckt   72u  IPv4 0x2097c8deb18ef4cf      0t0  TCP *:57621 (LISTEN)
Spotify   36908 vaneyckt   77u  IPv4 0x2097c8deb993b255      0t0  UDP ip-192-168-0-101.ec2.internal:61009
Spotify   36908 vaneyckt   90u  IPv4 0x2097c8dea8c4a66d      0t0  TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
Spotify   36908 vaneyckt   91u  IPv4 0x2097c8de8d029f2d      0t0  UDP ip-192-168-0-101.ec2.internal:52706
</code></pre>

<h4 id="list-all-network-connections-on-port-4381:af3807b2c0cfda8f5c0a92778b96cb1b">List all network connections on port 4381</h4>

<pre><code class="language-bash">$ lsof -i :4381

COMMAND   PID     USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Spotify 36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
</code></pre>

<h4 id="find-ports-listening-for-connections:af3807b2c0cfda8f5c0a92778b96cb1b">Find ports listening for connections</h4>

<pre><code class="language-bash">$ lsof -i | grep -i LISTEN

Spotify   36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
Spotify   36908 vaneyckt   54u  IPv4 0x2097c8deab18027d      0t0  TCP localhost:4371 (LISTEN)
Spotify   36908 vaneyckt   72u  IPv4 0x2097c8deb18ef4cf      0t0  TCP *:57621 (LISTEN)
</code></pre>

<h4 id="find-established-connections:af3807b2c0cfda8f5c0a92778b96cb1b">Find established connections</h4>

<pre><code class="language-bash">$ lsof -i | grep -i ESTABLISHED

Spotify   36908 vaneyckt   90u  IPv4 0x2097c8dea8c4a66d      0t0  TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
</code></pre>

<h4 id="show-all-files-opened-by-a-given-process:af3807b2c0cfda8f5c0a92778b96cb1b">Show all files opened by a given process</h4>

<pre><code class="language-bash">$ lsof -p 36908

COMMAND   PID     USER   FD     TYPE             DEVICE  SIZE/OFF     NODE NAME
Spotify 36908 vaneyckt   90u    IPv4 0x2097c8dea8c4a66d       0t0      TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
Spotify 36908 vaneyckt   91u    IPv4 0x2097c8de8d029f2d       0t0      UDP ip-192-168-0-101.ec2.internal:52706
Spotify 36908 vaneyckt   92u     REG                1,4   9389456 59387889 /Users/vaneyckt/Library/Caches/com.spotify.client/Data/4a/4a5a23cf1e9dc4210b3c801d57a899098dc12418.file
Spotify 36908 vaneyckt   93u     REG                1,4   8658944 58471210 /private/var/folders/xv/fjmwzr9x5mq_s7dchjq87hjm0000gn/T/.org.chromium.Chromium.6b0Vzp
Spotify 36908 vaneyckt   94u     REG                1,4    524656 54784499 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/index
Spotify 36908 vaneyckt   95u     REG                1,4     81920 54784500 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_0
Spotify 36908 vaneyckt   96u     REG                1,4    532480 54784501 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_1
Spotify 36908 vaneyckt   97u     REG                1,4   2105344 54784502 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_2
Spotify 36908 vaneyckt   98u     REG                1,4  12591104 54784503 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_3
Spotify 36908 vaneyckt   99r     REG                1,4    144580    28952 /System/Library/Frameworks/Carbon.framework/Versions/A/Frameworks/HIToolbox.framework/Versions/A/Resources/HIToolbox.rsrc
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/carefully_converting_your_mysql_database_to_utf8/">
        Carefully converting your MySQL database to utf8
      </a>
    </h1>

    <span class="post-date">Oct 20, 2013</span>

    


    <p>Converting all the data in your database can be a nail-biting experience. As you can see from the code below we are doing our best to be super careful. We convert each table separately and before each conversion we store the table&rsquo;s column types and an MD5 hash of every row in the table (we were lucky enough to not have enormous tables). After converting the table we check that no column types or rows were changed. It goes without saying that we do a trial run on a database dump first.</p>

<pre><code class="language-ruby">require 'set'
require 'digest/md5'

CHARACTER_SET = 'utf8'
COLLATION = 'utf8_unicode_ci'

class ConvertAllTablesToUtf8 &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.connection.tables.each do |table|
      ActiveRecord::Base.transaction do
        ActiveRecord::Base.connection.execute(&quot;LOCK TABLES #{table} WRITE&quot;)
          say &quot;starting work on table: #{table}&quot;

          model = table.classify.constantize
          say &quot;associated model: #{model}&quot;

          say 'storing column types information before converting table to unicode'
          column_types_before = model.columns_hash.each_with_object({}) do |(column_name, column_info), column_types_before|
            column_types_before[column_name] = [column_info.sql_type, column_info.type]
          end

          say 'storing set of table data hashes before converting table to unicode'
          table_data_before = Set.new
          model.find_each do |datum|
            table_data_before &lt;&lt; Digest::MD5.hexdigest(datum.inspect)
          end

          say 'converting table to unicode'
          execute(&quot;ALTER TABLE #{table} CONVERT TO CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
          execute(&quot;ALTER TABLE #{table} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)

          say 'getting column types information after conversion to unicode'
          column_types_after = model.columns_hash.each_with_object({}) do |(column_name, column_info), column_types_after|
            column_types_after[column_name] = [column_info.sql_type, column_info.type]
          end

          say 'getting set of table data hashes after conversion to unicode'
          table_data_after = Set.new
          model.find_each do |datum|
            table_data_after &lt;&lt; Digest::MD5.hexdigest(datum.inspect)
          end

          say &quot;checking that column types haven't changed&quot;
          if column_types_before != column_types_after
            raise &quot;Column types of the #{table} table have changed&quot;
          end

          say &quot;checking that data hasn't changed&quot;
          if table_data_before != table_data_after
            raise &quot;Data in the #{table} table has changed&quot;
          end
        ActiveRecord::Base.connection.execute('UNLOCK TABLES')
      end
    end

    execute(&quot;ALTER DATABASE #{ActiveRecord::Base.connection.current_database} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
  end

  def down
    raise ActiveRecord::IrreversibleMigration
  end
end
</code></pre>

<p>Note how we lock each table before converting it. If we didn&rsquo;t lock it then new data could be written to the table while we are busy storing MD5 hashes of the rows in preparation for the actual conversion. This, in turn, would cause our migration to complain that new data was present after the conversion had taken place.</p>

<p>We also wrap each table conversion inside a transaction. I&rsquo;ve talked before about <a href="http://vaneyckt.io/posts/rails_migrations_and_the_dangers_of_implicit_commits/">how converting a table will cause an implicit commit</a>, meaning that a rollback won&rsquo;t undo any of the changes made by the conversion. So why have a transaction here then? Imagine that an exception were to be raised during our migration. In that case we want to ensure our table lock gets dropped as soon as possible. The transaction guarantees this behavior.</p>

<p>Also, if we weren&rsquo;t so paranoid about checking the before and after data as part of our migration, we could simplify this code quite a bit.</p>

<pre><code class="language-ruby">CHARACTER_SET = 'utf8'
COLLATION = 'utf8_unicode_ci'

class ConvertAllTablesToUtf8 &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.connection.tables.each do |table|
      say 'converting table to unicode'
      execute(&quot;ALTER TABLE #{table} CONVERT TO CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
      execute(&quot;ALTER TABLE #{table} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
    end

    execute(&quot;ALTER DATABASE #{ActiveRecord::Base.connection.current_database} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
  end

  def down
    raise ActiveRecord::IrreversibleMigration
  end
end
</code></pre>

<p>Notice how we can drop the lock as the <code>ALTER TABLE</code> command <a href="https://dev.mysql.com/doc/refman/5.1/en/alter-table.html">will prevent all writes to the table while simultaneously allowing all reads</a>.</p>

<blockquote>
<p>In most cases, ALTER TABLE makes a temporary copy of the original table. MySQL waits for other operations that are modifying the table, then proceeds. It incorporates the alteration into the copy, deletes the original table, and renames the new one. While ALTER TABLE is executing, the original table is readable by other sessions. Updates and writes to the table that begin after the ALTER TABLE operation begins are stalled until the new table is ready, then are automatically redirected to the new table without any failed updates. The temporary copy of the original table is created in the database directory of the new table. This can differ from the database directory of the original table for ALTER TABLE operations that rename the table to a different database.</p>
</blockquote>

<p>Furthermore, since we now no longer have a lock on our table we can also drop the transaction. This gives us the much-simplified code shown above.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/character_set_vs_collation/">
        Character set vs collation
      </a>
    </h1>

    <span class="post-date">Oct 19, 2013</span>

    


    <p>There&rsquo;s a surprising amount of confusion about the difference between these two terms. The best explanation I&rsquo;ve found is <a href="http://stackoverflow.com/questions/341273/what-does-character-set-and-collation-mean-exactly/341481#341481">here</a>.</p>

<blockquote>
<p>A character set is a subset of all written glyphs. A character encoding specifies how those characters are mapped to numeric values. Some character encodings, like UTF-8 and UTF-16, can encode any character in the Universal Character Set. Others, like US-ASCII or ISO-8859-1 can only encode a small subset, since they use 7 and 8 bits per character, respectively. Because many standards specify both a character set and a character encoding, the term &ldquo;character set&rdquo; is often substituted freely for &ldquo;character encoding&rdquo;.</p>

<p>A collation comprises rules that specify how characters can be compared for sorting. Collations rules can be locale-specific: the proper order of two characters varies from language to language.</p>

<p>Choosing a character set and collation comes down to whether your application is internationalized or not. If not, what locale are you targeting?</p>

<p>In order to choose what character set you want to support, you have to consider your application. If you are storing user-supplied input, it might be hard to foresee all the locales in which your software will eventually be used. To support them all, it might be best to support the UCS (Unicode) from the start. However, there is a cost to this; many western European characters will now require two bytes of storage per character instead of one.</p>

<p>Choosing the right collation can help performance if your database uses the collation to create an index, and later uses that index to provide sorted results. However, since collation rules are often locale-specific, that index will be worthless if you need to sort results according to the rules of another locale.</p>
</blockquote>

<p>The only thing I&rsquo;d like to add is that some collations are more cpu intensive than others. For example, <code>utf8_general_ci</code> treats À, Á, and Å as being equal to A when doing comparisons. This is in contrast to <code>utf8_unicode_ci</code> which uses about 10% more cpu, but differentiates between these characters.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/mysql_write_locks_also_prevent_reads/">
        MySQL write locks also prevent reads
      </a>
    </h1>

    <span class="post-date">Oct 17, 2013</span>

    


    <p>Locking a table with</p>

<pre><code class="language-ruby">table_name = 'widgets'
ActiveRecord::Base.connection.execute(&quot;LOCK TABLES #{table_name} WRITE&quot;)
</code></pre>

<p>ensures that <a href="http://dev.mysql.com/doc/refman/5.0/en/lock-tables.html">only the current connection can access that table</a>. Other connections cannot even read from this table while it is locked!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/rails_migrations_and_the_dangers_of_implicit_commits/">
        Rails migrations and the dangers of implicit commits
      </a>
    </h1>

    <span class="post-date">Oct 16, 2013</span>

    


    <p>I recently came across the migration below. At first sight it looks like everything is okay, but there is actually a very dangerous assumption being made here.</p>

<pre><code class="language-ruby"># migration to convert table to utf8
class ConvertWidgetsTableToUtf8Unicode &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.transaction do
      table_name = 'widgets'
      say &quot;converting #{table_name} table to utf8_unicode_ci&quot;

      execute(&quot;ALTER TABLE #{table_name} CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci&quot;)
      execute(&quot;ALTER TABLE #{table_name} DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci&quot;)
    end
  end
end
</code></pre>

<p>Notice how the utf8 conversion code is wrapped inside a transaction. The assumption here is that if something goes wrong the transaction will trigger a rollback. However, an <code>ALTER TABLE</code> command in MySQL causes an <a href="http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html">implicit commit</a>. This means that the rollback will not undo any changes introduced by the <code>ALTER TABLE</code> command!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/iterating_over_a_hash_containing_arrays/">
        Iterating over a hash containing arrays
      </a>
    </h1>

    <span class="post-date">Oct 15, 2013</span>

    


    <p>Last week I was implementing some auditing functionality in a rails app. At some point I was writing a page that would display how the attributes of a given ActiveRecord object had been changed. One of my colleagues spotted this and pointed out the following neat bit of syntactic sugar in Ruby.</p>

<pre><code class="language-ruby">changes = {:attribute_a =&gt; [1, 2], :attribute_b =&gt; [3, 4]}

changes.each do |attribute, (before, after)|
  puts &quot;#{attribute}: #{before} - #{after}&quot;
end
</code></pre>

<p>I later learned you can even do things like this.</p>

<pre><code class="language-ruby">data = {:foo =&gt; [[1, 2], 3]}

data.each do |key, ((a, b), c)|
  puts &quot;#{key}: #{a} - #{b} - #{c}&quot;
end
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/uri_js_and_url_manipulation_in_rails/">
        URI.js and URL manipulation in rails
      </a>
    </h1>

    <span class="post-date">Oct 13, 2013</span>

    


    <p>Manipulating urls in javascript often ends up being an exercise in string interpolation. This rarely produces good looking code. Recently we&rsquo;ve started enforcing the use of the <a href="https://medialize.github.io/URI.js/">URI.js library</a> to combat this.</p>

<p>Our new approach has us embed any necessary urls in hidden input fields on the web page in question. Rather than hardcoding these urls, we use the named route functionality offered by rails as this provides more flexibility. When the page gets rendered, these named routes are converted to actual urls through ERB templating. The embedded urls can then be fetched by javascript code and manipulated with URI.js.</p>

<p>It&rsquo;s no silver bullet, but the resulting code is a lot more readable.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/the_css_important_keyword/">
        The css !important keyword
      </a>
    </h1>

    <span class="post-date">Oct 12, 2013</span>

    


    <p>Today I learned about the css !important keyword. I was trying to change the way code snippets (gists) were being displayed on a site, but found my css rules being ignored.</p>

<p>As it turned out, the javascript snippets used for embedding gists were adding an additional css stylesheet to the page. Since this stylesheet was getting added after my own stylesheet, its rules had priority over my own. The solution was to add <code>!important</code> to my own rules.</p>

<pre><code class="language-css">.gist-data {
  border-bottom: 1px !important;
}
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/finding_models_from_strings_with_rails/">
        Finding models from strings with rails
      </a>
    </h1>

    <span class="post-date">Oct 11, 2013</span>

    


    <p>Imagine you have a Widget model that stores data in a table &lsquo;widgets&rsquo;. At some point in your rails app you find yourself being given a string &lsquo;Widget&rsquo; and are asked to find the Widget model. This can be done like shown here.</p>

<pre><code class="language-ruby">str = 'Widget'
model = str.constantize
</code></pre>

<p>However, things get a bit harder when you have multiple Widget model subclasses (Widget::A, Widget::B), all of which are stored in the widgets table. This time around you&rsquo;re given the string &lsquo;Widget::A&rsquo; and are asked to get the Widget model.</p>

<p>In order to solve this we&rsquo;ll need to ask the Widget::A model to give us its table name. If you&rsquo;re following rails conventions you can then in turn use the table name to get the model you need.</p>

<pre><code class="language-ruby">str = 'Widget'
model = str.constantize.table_name.classify.constantize
</code></pre>

<p>Note that the above will only work if you&rsquo;ve followed rails naming conventions though :).</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/retrieving_data_in_a_time_range_with_rails/">
        Retrieving data in a time range with rails
      </a>
    </h1>

    <span class="post-date">Oct 10, 2013</span>

    


    <p>I&rsquo;m writing this mostly as a reminder to myself, since I keep forgetting this :)</p>

<p>Instead of:</p>

<pre><code class="language-ruby">widgets = Widget.where(&quot;? &lt;= created_at AND created_at &lt;= ?&quot;, time_from, time_to)
</code></pre>

<p>do this:</p>

<pre><code class="language-ruby">widgets = Widget.where(:created_at =&gt; time_from .. time_to)
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/get_vs_post/">
        GET vs POST
      </a>
    </h1>

    <span class="post-date">Oct 9, 2013</span>

    


    

<p>Today I was looking into why a particular GET request was failing on IE. As it turned out this was due to IE not appreciating long query strings. While going through our nginx logs, we also found nginx had a default query string limit that was being hit sporadically by some other customers as well. The solution in both cases was to move the affected calls from GET to POST.</p>

<p>The above problem prompted me to take a closer look at the differences between GET and POST requests. You probably use these all the time, but do you know how each of them functions?</p>

<h4 id="get-requests:4d95a9bef13dce29490ef41cb06ad212">GET requests</h4>

<ul>
<li>can be bookmarked</li>
<li>can be cached for faster response time on subsequent request</li>
<li>request is stored in browser history</li>
<li>uses query strings to send data. There is a limit to the allowable length of a query string.</li>
<li>have their url and query strings stored in plaintext in server logs. This is why you should never send passwords over GET requests!</li>
<li>use these for actions that retrieve data. For example, you don&rsquo;t want to use GET requests for posting comments on your blog. Otherwise an attacker could copy a url that posts a specific comment and put it on twitter. Every time someone were to click this link, a comment would now be posted on your blog.</li>
</ul>

<h4 id="post-requests:4d95a9bef13dce29490ef41cb06ad212">POST requests</h4>

<ul>
<li>cannot be bookmarked</li>
<li>cannot be cached</li>
<li>request will not be stored in browser history</li>
<li>uses POST body to send data. There is no limit to the amount of data sent due to the multipart content-type spreading your data across multiple messages when necessary.</li>
<li>have their url stored in plaintext in server logs. The data itself will not be logged though.</li>
<li>use these for actions that alter data</li>
</ul>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/the_dig_command/">
        The dig command
      </a>
    </h1>

    <span class="post-date">Oct 8, 2013</span>

    


    <p>Today I learned of the existence of the <a href="http://linux.die.net/man/1/dig">dig command</a>. A very useful little tool for DNS lookups. Here&rsquo;s an example of it in action.</p>

<pre><code class="language-bash">$ dig www.google.com

; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; www.google.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 4868
;; flags: qr rd ra; QUERY: 1, ANSWER: 6, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.google.com.			IN	A

;; ANSWER SECTION:
www.google.com.		72	IN	A	74.125.24.105
www.google.com.		72	IN	A	74.125.24.103
www.google.com.		72	IN	A	74.125.24.104
www.google.com.		72	IN	A	74.125.24.99
www.google.com.		72	IN	A	74.125.24.147
www.google.com.		72	IN	A	74.125.24.106

;; Query time: 11 msec
;; SERVER: 192.168.0.1#53(192.168.0.1)
;; WHEN: Sat Aug 29 13:38:48 2015
;; MSG SIZE  rcvd: 128
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/profiling_rails_assets_precompilation/">
        Profiling rails assets precompilation
      </a>
    </h1>

    <span class="post-date">Sep 1, 2013</span>

    


    <p>Assets precompilation on rails can take a fair bit of time. This is especially annoying in scenarios where you want to deploy your app multiple times a day. Let&rsquo;s see if we can come up with a way to actually figure out where all this time is being spent. Also, while I will be focusing on rails 3.2 in this post, the general principle should be easy enough to apply to other rails versions.</p>

<p>Our first call of action is finding the assets precompilation logic. A bit of digging will turn up the <a href="https://github.com/rails/rails/blob/3-2-stable/actionpack/lib/sprockets/assets.rake">assets.rake file</a> for rails 3.2. The relevant code starts on lines 59-67 and from there on out invokes methods throughout the entire file.</p>

<pre><code class="language-ruby"># lines 59-67 of assets.rake
task :all do
  Rake::Task[&quot;assets:precompile:primary&quot;].invoke
  # We need to reinvoke in order to run the secondary digestless
  # asset compilation run - a fresh Sprockets environment is
  # required in order to compile digestless assets as the
  # environment has already cached the assets on the primary
  # run.
  if Rails.application.config.assets.digest
    ruby_rake_task(&quot;assets:precompile:nondigest&quot;, false)
  end
end
</code></pre>

<p>When we follow the calls made by the code above we can see that the actual compilation takes place on lines 50-56 of assets.rake and is done by the compile method of the <a href="https://github.com/rails/rails/blob/3-2-stable/actionpack/lib/sprockets/static_compiler.rb">Sprockets::StaticCompiler class</a>.</p>

<pre><code class="language-ruby"># compile method of Sprockets::StaticCompiler class
def compile
  manifest = {}
  env.each_logical_path(paths) do |logical_path|
    if asset = env.find_asset(logical_path)
      digest_path = write_asset(asset)
      manifest[asset.logical_path] = digest_path
      manifest[aliased_path_for(asset.logical_path)] = digest_path
    end
  end
  write_manifest(manifest) if @manifest
end
</code></pre>

<p>Now that we know which code does the compiling, we can think of two ways to add some profiling to this. We could checkout the rails repo from Github, modify it locally and point our Gemfile to our modified local version of rails. Or, we could create a new rake task and monkey patch the compile method of the Sprockets::StaticCompiler class. We&rsquo;ll go with the second option here as it is the more straightforward to implement.</p>

<p>We&rsquo;ll create a new rake file in the /lib/tasks folder of our rails app and name it <code>profile_assets_precompilation.rake</code>. We then copy the contents of assets.rake into it, and wrap this code inside a new &lsquo;profile&rsquo; namespace so as to avoid conflicts. At the top of this file we&rsquo;ll also add our monkey patched compile method so as to make it output profiling info. The resulting file should look like shown below.</p>

<pre><code class="language-ruby">namespace :profile do
  # monkey patch the compile method to output compilation times
  module Sprockets
    class StaticCompiler
      def compile
        manifest = {}
        env.each_logical_path(paths) do |logical_path|
          start_time = Time.now.to_f

          if asset = env.find_asset(logical_path)
            digest_path = write_asset(asset)
            manifest[asset.logical_path] = digest_path
            manifest[aliased_path_for(asset.logical_path)] = digest_path
          end

          # our profiling code
          duration = Time.now.to_f - start_time
          puts &quot;#{logical_path} - #{duration.round(3)} seconds&quot;
        end
        write_manifest(manifest) if @manifest
      end
    end
  end

  # contents of assets.rake
  namespace :assets do
    def ruby_rake_task(task, fork = true)
      env    = ENV['RAILS_ENV'] || 'production'
      groups = ENV['RAILS_GROUPS'] || 'assets'
      args   = [$0, task,&quot;RAILS_ENV=#{env}&quot;,&quot;RAILS_GROUPS=#{groups}&quot;]
      args &lt;&lt; &quot;--trace&quot; if Rake.application.options.trace
      if $0 =~ /rake\.bat\Z/i
        Kernel.exec $0, *args
      else
        fork ? ruby(*args) : Kernel.exec(FileUtils::RUBY, *args)
      end
    end

    # We are currently running with no explicit bundler group
    # and/or no explicit environment - we have to reinvoke rake to
    # execute this task.
    def invoke_or_reboot_rake_task(task)
      if ENV['RAILS_GROUPS'].to_s.empty? || ENV['RAILS_ENV'].to_s.empty?
        ruby_rake_task task
      else
        Rake::Task[task].invoke
      end
    end

    desc &quot;Compile all the assets named in config.assets.precompile&quot;
    task :precompile do
      invoke_or_reboot_rake_task &quot;assets:precompile:all&quot;
    end

    namespace :precompile do
      def internal_precompile(digest=nil)
        unless Rails.application.config.assets.enabled
          warn &quot;Cannot precompile assets if sprockets is disabled. Please set config.assets.enabled to true&quot;
          exit
        end

        # Ensure that action view is loaded and the appropriate
        # sprockets hooks get executed
        _ = ActionView::Base

        config = Rails.application.config
        config.assets.compile = true
        config.assets.digest  = digest unless digest.nil?
        config.assets.digests = {}

        env      = Rails.application.assets
        target   = File.join(Rails.public_path, config.assets.prefix)
        compiler = Sprockets::StaticCompiler.new(env,
                                                 target,
                                                 config.assets.precompile,
                                                 :manifest_path =&gt; config.assets.manifest,
                                                 :digest =&gt; config.assets.digest,
                                                 :manifest =&gt; digest.nil?)
        compiler.compile
      end

      task :all do
        Rake::Task[&quot;assets:precompile:primary&quot;].invoke
        # We need to reinvoke in order to run the secondary digestless
        # asset compilation run - a fresh Sprockets environment is
        # required in order to compile digestless assets as the
        # environment has already cached the assets on the primary
        # run.
        ruby_rake_task(&quot;assets:precompile:nondigest&quot;, false) if Rails.application.config.assets.digest
      end

      task :primary =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        internal_precompile
      end

      task :nondigest =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        internal_precompile(false)
      end
    end

    desc &quot;Remove compiled assets&quot;
    task :clean do
      invoke_or_reboot_rake_task &quot;assets:clean:all&quot;
    end

    namespace :clean do
      task :all =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        config = Rails.application.config
        public_asset_path = File.join(Rails.public_path, config.assets.prefix)
        rm_rf public_asset_path, :secure =&gt; true
      end
    end

    task :environment do
      if Rails.application.config.assets.initialize_on_precompile
        Rake::Task[&quot;environment&quot;].invoke
      else
        Rails.application.initialize!(:assets)
        Sprockets::Bootstrap.new(Rails.application).run
      end
    end
  end
end
</code></pre>

<p>Now we can run <code>bundle exec rake profile:assets:precompile</code> to precompile our assets while outputting profiling info. Hopefully we can now finally figure out why this is always taking so long :).</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/regarding_if_statement_scope_in_ruby/">
        Regarding if statement scope in Ruby
      </a>
    </h1>

    <span class="post-date">Aug 31, 2013</span>

    


    <p>I recently learned that <code>if</code> statements in Ruby do not introduce scope. This means that you can write code like shown below and it&rsquo;ll work fine.</p>

<pre><code class="language-ruby"># perfectly valid Ruby code
if true
  foo = 5
end

puts foo
</code></pre>

<p>At first this seemed a bit weird to me. It wasn&rsquo;t until I read <a href="http://programmers.stackexchange.com/questions/58900/why-if-statements-do-not-introduce-scope-in-ruby-1-9">this</a> that I realized Ruby was even more versatile than I had first thought. As it turns out, it is this somewhat unconventional scoping rule that allows us to conditionally replace methods.</p>

<pre><code class="language-ruby">if foo == 5
  def some_method
    # do something
  end
else
  def some_method
    # do something else
  end
end
</code></pre>

<p>As well as conditionally modify implementations.</p>

<pre><code class="language-ruby">if foo == 5
  class someClass
    # ...
  end
else
  module someModule
    # ...
  end
end
</code></pre>

<p>And that&rsquo;s amazing!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:1313/posts/ec2_instance_cost_comparison/">
        EC2 instance cost comparison
      </a>
    </h1>

    <span class="post-date">Aug 11, 2013</span>

    


    <p>Amazon&rsquo;s pricing scheme for its ec2 instances never struck me as particularly transparent. Until recently some of my DevOps colleagues even estimated cost by cross-referencing <a href="https://aws.amazon.com/ec2/instance-types">instance details</a> with <a href="http://aws.amazon.com/ec2/pricing">pricing information</a>. While this approach gives reasonable results for finding the cost of a given instance type, it doesn&rsquo;t lend itself very well to comparing prices across a range of different types.</p>

<p>When talking to an ex-colleague of mine about the hardships encountered for such a common task, he pointed me to <a href="http://www.ec2instances.info">this absolutely brilliant page</a>. It&rsquo;s so unbelievably simple and well thought-out that I can&rsquo;t help getting ever so slightly annoyed with whomever is in charge of communicating Amazon&rsquo;s pricing structure and the subpar job they are doing.</p>

  </div>
  
  
</div>


  <script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
