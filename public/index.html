<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta property="og:title" content="vaneyckt" />
<meta property="og:description" content="" />

<meta property="og:type" content="website" />

<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://vaneyckt.io/" />


  <title> vaneyckt </title>

  
  <link href="http://vaneyckt.io/index.xml" rel="alternate" type="application/rss+xml" title="vaneyckt" />
  <link href="http://vaneyckt.io/index.xml" rel="feed" type="application/rss+xml" title="vaneyckt" />
  

  <link rel="stylesheet" href="/css/monokai.css">
  <script src="/js/highlight.pack.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="stylesheet" href="http://vaneyckt.io/css/poole.css">
  <link rel="stylesheet" href="http://vaneyckt.io/css/syntax.css">
  <link rel="stylesheet" href="http://vaneyckt.io/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://vaneyckt.io/index.xml" rel="alternate" type="application/rss+xml" title="vaneyckt" />

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <link href='http://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>

  <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Raleway']
      }
    });
  </script>
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1 class="brand"><a href="http://vaneyckt.io">vaneyckt</a></h1>
      <p class="lead">
         notes to my future self 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://vaneyckt.io/posts">Posts</a></li>
      <li><a href="http://vaneyckt.io/tags">Topics</a></li>
      
      <br/>
      
    </ul>
      
      
      
      <a href="https://github.com/vaneyckt"><i class="fa fa-github-square"></i></a>&nbsp;&nbsp;
      

    <p class="footnote">powered by <a href="http://hugo.spf13.com">Hugo</a> <br/>
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/installing_chromedriver/">
        Installing Chromedriver
      </a>
    </h1>

    <span class="post-date">Aug 16, 2015</span>

    


    <p>Some time ago I needed to install <a href="https://sites.google.com/a/chromium.org/chromedriver/">chromedriver</a> on a ubuntu machine. While this wasn&rsquo;t too hard, I was nevertheless surprised by the number of open <a href="https://stackoverflow.com/">StackOverflow</a> questions on this topic. So I decided to leave some notes for my future self.</p>

<p>First of all, let&rsquo;s install chromedriver.</p>

<pre><code class="language-bash">$ LATEST_RELEASE=$(curl http://chromedriver.storage.googleapis.com/LATEST_RELEASE)
$ wget http://chromedriver.storage.googleapis.com/$LATEST_RELEASE/chromedriver_linux64.zip
$ unzip chromedriver_linux64.zip
$ rm chromedriver_linux64.zip
$ sudo mv chromedriver /usr/local/bin
</code></pre>

<p>Let&rsquo;s see what happens when we try and run it.</p>

<pre><code class="language-bash">$ chromedriver
    chromedriver: error while loading shared libraries: libgconf-2.so.4:
    cannot open shared object file: No such file or directory
</code></pre>

<p>That&rsquo;s a bit unexpected. Luckily we can easily fix this.</p>

<pre><code class="language-bash">$ sudo apt-get install libgconf-2-4
</code></pre>

<p>Now that we have a functioning chromedriver, the only thing left to do is to install Chrome. After all, chromedriver can&rsquo;t function without Chrome.</p>

<pre><code class="language-bash">$ wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
$ sudo sh -c 'echo &quot;deb http://dl.google.com/linux/chrome/deb/ stable main&quot; &gt;&gt; /etc/apt/sources.list.d/google.list'
$ sudo apt-get update
$ sudo apt-get install google-chrome-stable
</code></pre>

<p>And that&rsquo;s it. You should be good to go now.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/get_connection_information_with_the_lsof_command/">
        Get connection information with the lsof command
      </a>
    </h1>

    <span class="post-date">Oct 21, 2013</span>

    


    <p>The <a href="http://linux.die.net/man/8/lsof">lsof command</a> is one of those super useful commands for figuring out what connections are taking place on your machine. While the <code>lsof</code> command technically just <strong>l</strong>i<strong>s</strong>ts <strong>o</strong>pen <strong>f</strong>iles, just about everything in linux (even sockets) is a file!</p>

<p>Some useful commands:</p>

<p>####List all network connections</p>

<pre><code class="language-bash">$ lsof -i

COMMAND     PID     USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Spotify   36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
Spotify   36908 vaneyckt   54u  IPv4 0x2097c8deab18027d      0t0  TCP localhost:4371 (LISTEN)
Spotify   36908 vaneyckt   71u  IPv4 0x2097c8deba747c1d      0t0  UDP *:57621
Spotify   36908 vaneyckt   72u  IPv4 0x2097c8deb18ef4cd      0t0  TCP *:57621 (LISTEN)
Spotify   36908 vaneyckt   77u  IPv4 0x2097c8deb993b255      0t0  UDP ip-192-168-0-101.ec2.internal:61009
Spotify   36908 vaneyckt   90u  IPv4 0x2097c8dea8c4a66d      0t0  TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
Spotify   36908 vaneyckt   91u  IPv4 0x2097c8de8d029f2d      0t0  UDP ip-192-168-0-101.ec2.internal:52706
</code></pre>

<p>####List all network connections on port 4381</p>

<pre><code class="language-bash">$ lsof -i :4381

COMMAND   PID     USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Spotify 36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
</code></pre>

<p>####Find ports listening for connections</p>

<pre><code class="language-bash">$ lsof -i | grep -i LISTEN

Spotify   36908 vaneyckt   53u  IPv4 0x2097c8deb175c0dd      0t0  TCP localhost:4381 (LISTEN)
Spotify   36908 vaneyckt   54u  IPv4 0x2097c8deab18027d      0t0  TCP localhost:4371 (LISTEN)
Spotify   36908 vaneyckt   72u  IPv4 0x2097c8deb18ef4cd      0t0  TCP *:57621 (LISTEN)
</code></pre>

<p>####Find established connections</p>

<pre><code class="language-bash">$ lsof -i | grep -i ESTABLISHED

Spotify   36908 vaneyckt   90u  IPv4 0x2097c8dea8c4a66d      0t0  TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
</code></pre>

<p>####Show all files opened by a given process</p>

<pre><code class="language-bash">$ lsof -p 36908

COMMAND   PID     USER   FD     TYPE             DEVICE  SIZE/OFF     NODE NAME
Spotify 36908 vaneyckt   90u    IPv4 0x2097c8dea8c4a66d       0t0      TCP ip-192-168-0-101.ec2.internal:62432-&gt;lon3-accesspoint-a57.lon3.spotify.com:https (ESTABLISHED)
Spotify 36908 vaneyckt   91u    IPv4 0x2097c8de8d029f2d       0t0      UDP ip-192-168-0-101.ec2.internal:52706
Spotify 36908 vaneyckt   92u     REG                1,4   9389456 59387889 /Users/vaneyckt/Library/Caches/com.spotify.client/Data/4a/4a5a23cf1e9dc4210b3c801d57a899098dc12418.file
Spotify 36908 vaneyckt   93u     REG                1,4   8658944 58471210 /private/var/folders/xv/fjmwzr9x5mq_s7dchjq87hjm0000gn/T/.org.chromium.Chromium.6b0Vzp
Spotify 36908 vaneyckt   94u     REG                1,4    524656 54784499 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/index
Spotify 36908 vaneyckt   95u     REG                1,4     81920 54784500 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_0
Spotify 36908 vaneyckt   96u     REG                1,4    532480 54784501 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_1
Spotify 36908 vaneyckt   97u     REG                1,4   2105344 54784502 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_2
Spotify 36908 vaneyckt   98u     REG                1,4  12591104 54784503 /Users/vaneyckt/Library/Caches/com.spotify.client/Browser/data_3
Spotify 36908 vaneyckt   99r     REG                1,4    144580    28952 /System/Library/Frameworks/Carbon.framework/Versions/A/Frameworks/HIToolbox.framework/Versions/A/Resources/HIToolbox.rsrc
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/the_paranoid_approach_to_converting_your_mysql_database_to_utf8/">
        The paranoid approach to converting your MySQL database to utf8
      </a>
    </h1>

    <span class="post-date">Oct 20, 2013</span>

    


    <p>Converting all the data in your database can be a nail-biting experience. As you can see from the code below we are doing our best to be super careful. We convert each table separately and before each conversion we store the table&rsquo;s column types and an MD5 hash of every row in the table (we were lucky enough to not have enormous tables). After converting the table we check that no column types or rows were changed. It goes without saying that we do a trial run on a database dump first.</p>

<pre><code class="language-ruby">require 'set'
require 'digest/md5'

CHARACTER_SET = 'utf8'
COLLATION = 'utf8_unicode_ci'

class ConvertAllTablesToUtf8 &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.connection.tables.each do |table|
      ActiveRecord::Base.transaction do
        ActiveRecord::Base.connection.execute(&quot;LOCK TABLES #{table} WRITE&quot;)
          say &quot;starting work on table: #{table}&quot;

          model = table.classify.constantize
          say &quot;associated model: #{model}&quot;

          say 'storing column types information before converting table to unicode'
          column_types_before = model.columns_hash.each_with_object({}) do |(column_name, column_info), column_types_before|
            column_types_before[column_name] = [column_info.sql_type, column_info.type]
          end

          say 'storing set of table data hashes before converting table to unicode'
          table_data_before = Set.new
          model.find_each do |datum|
            table_data_before &lt;&lt; Digest::MD5.hexdigest(datum.inspect)
          end

          say 'converting table to unicode'
          execute(&quot;ALTER TABLE #{table} CONVERT TO CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
          execute(&quot;ALTER TABLE #{table} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)

          say 'getting column types information after conversion to unicode'
          column_types_after = model.columns_hash.each_with_object({}) do |(column_name, column_info), column_types_after|
            column_types_after[column_name] = [column_info.sql_type, column_info.type]
          end

          say 'getting set of table data hashes after conversion to unicode'
          table_data_after = Set.new
          model.find_each do |datum|
            table_data_after &lt;&lt; Digest::MD5.hexdigest(datum.inspect)
          end

          say &quot;checking that column types haven't changed&quot;
          if column_types_before != column_types_after
            raise &quot;Column types of the #{table} table have changed&quot;
          end

          say &quot;checking that data hasn't changed&quot;
          if table_data_before != table_data_after
            raise &quot;Data in the #{table} table has changed&quot;
          end
        ActiveRecord::Base.connection.execute('UNLOCK TABLES')
      end
    end

    execute(&quot;ALTER DATABASE #{ActiveRecord::Base.connection.current_database} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
  end

  def down
    raise ActiveRecord::IrreversibleMigration
  end
end
</code></pre>

<p>Note how we lock each table before converting it. If we didn&rsquo;t lock it then new data could be written to the table while we are busy storing MD5 hashes of the rows in preparation for the actual conversion. This, in turn, would cause our migration to complain that new data was present after the conversion had taken place.</p>

<p>We also wrap each table conversion inside a transaction. I&rsquo;ve talked before about <a href="http://vaneyckt.io/posts/rails_migrations_and_the_dangers_of_implicit_commits/">how converting a table will cause an implicit commit</a>, meaning that a rollback won&rsquo;t undo any of the changes made by the conversion. So why have a transaction here then? Imagine that an exception were to be raised during our migration. In that case we want to ensure our table lock gets dropped as soon as possible. The transaction guarantees this behavior.</p>

<p>Also, if we weren&rsquo;t so paranoid about checking the before and after data as part of our migration, we could simplify this code quite a bit.</p>

<pre><code class="language-ruby">CHARACTER_SET = 'utf8'
COLLATION = 'utf8_unicode_ci'

class ConvertAllTablesToUtf8 &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.connection.tables.each do |table|
      say 'converting table to unicode'
      execute(&quot;ALTER TABLE #{table} CONVERT TO CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
      execute(&quot;ALTER TABLE #{table} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
    end

    execute(&quot;ALTER DATABASE #{ActiveRecord::Base.connection.current_database} DEFAULT CHARACTER SET #{CHARACTER_SET} COLLATE #{COLLATION}&quot;)
  end

  def down
    raise ActiveRecord::IrreversibleMigration
  end
end
</code></pre>

<p>Notice how we can drop the lock as the <code>ALTER TABLE</code> command <a href="https://dev.mysql.com/doc/refman/5.1/en/alter-table.html">will prevent all writes to the table while simultaneously allowing all reads</a>.</p>

<blockquote>
<p>In most cases, ALTER TABLE makes a temporary copy of the original table. MySQL waits for other operations that are modifying the table, then proceeds. It incorporates the alteration into the copy, deletes the original table, and renames the new one. While ALTER TABLE is executing, the original table is readable by other sessions. Updates and writes to the table that begin after the ALTER TABLE operation begins are stalled until the new table is ready, then are automatically redirected to the new table without any failed updates. The temporary copy of the original table is created in the database directory of the new table. This can differ from the database directory of the original table for ALTER TABLE operations that rename the table to a different database.</p>
</blockquote>

<p>Furthermore, since we now no longer have a lock on our table we can also drop the transaction. This gives us the much-simplified code shown above.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/character_set_vs_collation/">
        Character set vs collation
      </a>
    </h1>

    <span class="post-date">Oct 19, 2013</span>

    


    <p>There&rsquo;s a surprising amount of confusion about the difference between these two terms. The best explanation I&rsquo;ve found is <a href="http://stackoverflow.com/questions/341273/what-does-character-set-and-collation-mean-exactly/341481#341481">here</a>.</p>

<blockquote>
<p>A character set is a subset of all written glyphs. A character encoding specifies how those characters are mapped to numeric values. Some character encodings, like UTF-8 and UTF-16, can encode any character in the Universal Character Set. Others, like US-ASCII or ISO-8859-1 can only encode a small subset, since they use 7 and 8 bits per character, respectively. Because many standards specify both a character set and a character encoding, the term &ldquo;character set&rdquo; is often substituted freely for &ldquo;character encoding&rdquo;.</p>

<p>A collation comprises rules that specify how characters can be compared for sorting. Collations rules can be locale-specific: the proper order of two characters varies from language to language.</p>

<p>Choosing a character set and collation comes down to whether your application is internationalized or not. If not, what locale are you targeting?</p>

<p>In order to choose what character set you want to support, you have to consider your application. If you are storing user-supplied input, it might be hard to foresee all the locales in which your software will eventually be used. To support them all, it might be best to support the UCS (Unicode) from the start. However, there is a cost to this; many western European characters will now require two bytes of storage per character instead of one.</p>

<p>Choosing the right collation can help performance if your database uses the collation to create an index, and later uses that index to provide sorted results. However, since collation rules are often locale-specific, that index will be worthless if you need to sort results according to the rules of another locale.</p>
</blockquote>

<p>The only thing I&rsquo;d like to add is that some collations are more cpu intensive than others. For example, <code>utf8_general_ci</code> treats À, Á, and Å as being equal to A when doing comparisons. This is in contrast to <code>utf8_unicode_ci</code> which uses about 10% more cpu, but differentiates between these characters.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/mysql_write_locks_also_prevent_reads/">
        MySQL write locks also prevent reads
      </a>
    </h1>

    <span class="post-date">Oct 17, 2013</span>

    


    <p>Locking a table with</p>

<pre><code class="language-ruby">table_name = 'widgets'
ActiveRecord::Base.connection.execute(&quot;LOCK TABLES #{table_name} WRITE&quot;)
</code></pre>

<p>ensures that <a href="http://dev.mysql.com/doc/refman/5.0/en/lock-tables.html">only the current connection can access that table</a>. Other connections cannot even read from this table while it is locked!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/rails_migrations_and_the_dangers_of_implicit_commits/">
        Rails migrations and the dangers of implicit commits
      </a>
    </h1>

    <span class="post-date">Oct 16, 2013</span>

    


    <p>I recently came across the migration below. At first sight it looks like everything is okay, but there is actually a very dangerous assumption being made here.</p>

<pre><code class="language-ruby"># migration to convert table to utf8
class ConvertWidgetsTableToUtf8Unicode &lt; ActiveRecord::Migration
  def up
    ActiveRecord::Base.transaction do
      table_name = 'widgets'
      say &quot;converting #{table_name} table to utf8_unicode_ci&quot;

      execute(&quot;ALTER TABLE #{table_name} CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci&quot;)
      execute(&quot;ALTER TABLE #{table_name} DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci&quot;)
    end
  end
end
</code></pre>

<p>Notice how the utf8 conversion code is wrapped inside a transaction. The assumption here is that if something goes wrong the transaction will trigger a rollback. However, an <code>ALTER TABLE</code> command in MySQL causes an <a href="http://dev.mysql.com/doc/refman/5.0/en/implicit-commit.html">implicit commit</a>. This means that the rollback will not undo any changes introduced by the <code>ALTER TABLE</code> command!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/iterating_over_a_hash_containing_arrays/">
        Iterating over a hash containing arrays
      </a>
    </h1>

    <span class="post-date">Oct 15, 2013</span>

    


    <p>Last week I was implementing some auditing functionality in a rails app. At some point I was writing a page that would display how the attributes of a given ActiveRecord object had been changed. One of my colleagues spotted this and pointed out the following neat bit of syntactic sugar in Ruby.</p>

<pre><code class="language-ruby">changes = {:attribute_a =&gt; [1, 2], :attribute_b =&gt; [3, 4]}

changes.each do |attribute, (before, after)|
  puts &quot;#{attribute}: #{before} - #{after}&quot;
end
</code></pre>

<p>I later learned you can even do things like this.</p>

<pre><code class="language-ruby">data = {:foo =&gt; [[1, 2], 3]}

data.each do |key, ((a, b), c)|
  puts &quot;#{key}: #{a} - #{b} - #{c}&quot;
end
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/uri_js_and_url_manipulation_in_rails/">
        URI.js and URL manipulation in rails
      </a>
    </h1>

    <span class="post-date">Oct 13, 2013</span>

    


    <p>Manipulating urls in javascript often ends up being an exercise in string interpolation. This rarely produces good looking code. Recently we&rsquo;ve started enforcing the use of the <a href="https://medialize.github.io/URI.js/">URI.js library</a> to combat this.</p>

<p>Our new approach has us embed any necessary urls in hidden input fields on the web page in question. Rather than hardcoding these urls, we use the named route functionality offered by rails as this provides more flexibility. When the page gets rendered, these named routes are converted to actual urls through ERB templating. The embedded urls can then be fetched by javascript code and manipulated with URI.js.</p>

<p>It&rsquo;s no silver bullet, but the resulting code is a lot more readable.</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/the_css_important_keyword/">
        The css !important keyword
      </a>
    </h1>

    <span class="post-date">Oct 12, 2013</span>

    


    <p>Today I learned about the css !important keyword. I was trying to change the way code snippets (gists) were being displayed on a site, but found my css rules being ignored.</p>

<p>As it turned out, the javascript snippets used for embedding gists were adding an additional css stylesheet to the page. Since this stylesheet was getting added after my own stylesheet, its rules had priority over my own. The solution was to add <code>!important</code> to my own rules.</p>

<pre><code class="language-css">.gist-data {
  border-bottom: 1px !important;
}
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/finding_models_from_strings_with_rails/">
        Finding models from strings with rails
      </a>
    </h1>

    <span class="post-date">Oct 11, 2013</span>

    


    <p>Imagine you have a Widget model that stores data in a table &lsquo;widgets&rsquo;. At some point in your rails app you find yourself being given a string &lsquo;Widget&rsquo; and are asked to find the Widget model. This can be done like shown here.</p>

<pre><code class="language-ruby">str = 'Widget'
model = str.constantize
</code></pre>

<p>However, things get a bit harder when you have multiple Widget model subclasses (Widget::A, Widget::B), all of which are stored in the widgets table. This time around you&rsquo;re given the string &lsquo;Widget::A&rsquo; and are asked to get the Widget model.</p>

<p>In order to solve this we&rsquo;ll need to ask the Widget::A model to give us its table name. If you&rsquo;re following rails conventions you can then in turn use the table name to get the model you need.</p>

<pre><code class="language-ruby">str = 'Widget'
model = str.constantize.table_name.classify.constantize
</code></pre>

<p>Note that the above will only work if you&rsquo;ve followed rails naming conventions though :).</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/retrieving_data_in_a_time_range_with_rails/">
        Retrieving data in a time range with rails
      </a>
    </h1>

    <span class="post-date">Oct 10, 2013</span>

    


    <p>I&rsquo;m writing this mostly as a reminder to myself, since I keep forgetting this :)</p>

<p>Instead of:</p>

<pre><code class="language-ruby">widgets = Widget.where(&quot;? &lt;= created_at AND created_at &lt;= ?&quot;, time_from, time_to)
</code></pre>

<p>do this:</p>

<pre><code class="language-ruby">widgets = Widget.where(:created_at =&gt; time_from .. time_to)
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/get_vs_post/">
        GET vs POST
      </a>
    </h1>

    <span class="post-date">Oct 9, 2013</span>

    


    

<p>Today I was looking into why a particular GET request was failing on IE. As it turned out this was due to IE not appreciating long query strings. While going through our nginx logs, we also found nginx had a default query string limit that was being hit sporadically by some other customers as well. The solution in both cases was to move the affected calls from GET to POST.</p>

<p>The above problem prompted me to take a closer look at the differences between GET and POST requests. You probably use these all the time, but do you know how each of them functions?</p>

<h4 id="get-requests:4d95a9bef13dce29490ef41cb06ad212">GET requests</h4>

<ul>
<li>can be bookmarked</li>
<li>can be cached for faster response time on subsequent request</li>
<li>request is stored in browser history</li>
<li>uses query strings to send data. There is a limit to the allowable length of a query string.</li>
<li>have their url and query strings stored in plaintext in server logs. This is why you should never send passwords over GET requests!</li>
<li>use these for actions that retrieve data. For example, you don&rsquo;t want to use GET requests for posting comments on your blog. Otherwise an attacker could copy a url that posts a specific comment and put it on twitter. Every time someone were to click this link, a comment would now be posted on your blog.</li>
</ul>

<h4 id="post-requests:4d95a9bef13dce29490ef41cb06ad212">POST requests</h4>

<ul>
<li>cannot be bookmarked</li>
<li>cannot be cached</li>
<li>request will not be stored in browser history</li>
<li>uses POST body to send data. There is no limit to the amount of data sent due to the multipart content-type spreading your data across multiple messages when necessary.</li>
<li>have their url stored in plaintext in server logs. The data itself will not be logged though.</li>
<li>use these for actions that alter data</li>
</ul>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/the_dig_command/">
        The dig command
      </a>
    </h1>

    <span class="post-date">Oct 8, 2013</span>

    


    <p>Today I learned of the existence of the <a href="http://linux.die.net/man/1/dig">dig command</a>. A very useful little tool for DNS lookups. Here&rsquo;s an example of it in action.</p>

<pre><code class="language-bash">$ dig www.google.com

; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; www.google.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 4868
;; flags: qr rd ra; QUERY: 1, ANSWER: 6, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.google.com.			IN	A

;; ANSWER SECTION:
www.google.com.		72	IN	A	74.125.24.105
www.google.com.		72	IN	A	74.125.24.103
www.google.com.		72	IN	A	74.125.24.104
www.google.com.		72	IN	A	74.125.24.99
www.google.com.		72	IN	A	74.125.24.147
www.google.com.		72	IN	A	74.125.24.106

;; Query time: 11 msec
;; SERVER: 192.168.0.1#53(192.168.0.1)
;; WHEN: Sat Aug 29 13:38:48 2015
;; MSG SIZE  rcvd: 128
</code></pre>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/profiling_rails_assets_precompilation/">
        Profiling rails assets precompilation
      </a>
    </h1>

    <span class="post-date">Sep 1, 2013</span>

    


    <p>Assets precompilation on rails can take a fair bit of time. This is especially annoying in scenarios where you want to deploy your app multiple times a day. Let&rsquo;s see if we can come up with a way to actually figure out where all this time is being spent. Also, while I will be focusing on rails 3.2 in this post, the general principle should be easy enough to apply to other rails versions.</p>

<p>Our first call of action is finding the assets precompilation logic. A bit of digging will turn up the <a href="https://github.com/rails/rails/blob/3-2-stable/actionpack/lib/sprockets/assets.rake">assets.rake file</a> for rails 3.2. The relevant code starts on lines 59-67 and from there on out invokes methods throughout the entire file.</p>

<pre><code class="language-ruby"># lines 59-67 of assets.rake
task :all do
  Rake::Task[&quot;assets:precompile:primary&quot;].invoke
  # We need to reinvoke in order to run the secondary digestless
  # asset compilation run - a fresh Sprockets environment is
  # required in order to compile digestless assets as the
  # environment has already cached the assets on the primary
  # run.
  if Rails.application.config.assets.digest
    ruby_rake_task(&quot;assets:precompile:nondigest&quot;, false)
  end
end
</code></pre>

<p>When we follow the calls made by the code above we can see that the actual compilation takes place on lines 50-56 of assets.rake and is done by the compile method of the <a href="https://github.com/rails/rails/blob/3-2-stable/actionpack/lib/sprockets/static_compiler.rb">Sprockets::StaticCompiler class</a>.</p>

<pre><code class="language-ruby"># compile method of Sprockets::StaticCompiler class
def compile
  manifest = {}
  env.each_logical_path(paths) do |logical_path|
    if asset = env.find_asset(logical_path)
      digest_path = write_asset(asset)
      manifest[asset.logical_path] = digest_path
      manifest[aliased_path_for(asset.logical_path)] = digest_path
    end
  end
  write_manifest(manifest) if @manifest
end
</code></pre>

<p>Now that we know which code does the compiling, we can think of two ways to add some profiling to this. We could checkout the rails repo from Github, modify it locally and point our Gemfile to our modified local version of rails. Or, we could create a new rake task and monkey patch the compile method of the Sprockets::StaticCompiler class. We&rsquo;ll go with the second option here as it is the more straightforward to implement.</p>

<p>We&rsquo;ll create a new rake file in the /lib/tasks folder of our rails app and name it <code>profile_assets_precompilation.rake</code>. We then copy the contents of assets.rake into it, and wrap this code inside a new &lsquo;profile&rsquo; namespace so as to avoid conflicts. At the top of this file we&rsquo;ll also add our monkey patched compile method so as to make it output profiling info. The resulting file should look like shown below.</p>

<pre><code class="language-ruby">namespace :profile do
  # monkey patch the compile method to output compilation times
  module Sprockets
    class StaticCompiler
      def compile
        manifest = {}
        env.each_logical_path(paths) do |logical_path|
          start_time = Time.now.to_f

          if asset = env.find_asset(logical_path)
            digest_path = write_asset(asset)
            manifest[asset.logical_path] = digest_path
            manifest[aliased_path_for(asset.logical_path)] = digest_path
          end

          # our profiling code
          duration = Time.now.to_f - start_time
          puts &quot;#{logical_path} - #{duration.round(3)} seconds&quot;
        end
        write_manifest(manifest) if @manifest
      end
    end
  end

  # contents of assets.rake
  namespace :assets do
    def ruby_rake_task(task, fork = true)
      env    = ENV['RAILS_ENV'] || 'production'
      groups = ENV['RAILS_GROUPS'] || 'assets'
      args   = [$0, task,&quot;RAILS_ENV=#{env}&quot;,&quot;RAILS_GROUPS=#{groups}&quot;]
      args &lt;&lt; &quot;--trace&quot; if Rake.application.options.trace
      if $0 =~ /rake\.bat\Z/i
        Kernel.exec $0, *args
      else
        fork ? ruby(*args) : Kernel.exec(FileUtils::RUBY, *args)
      end
    end

    # We are currently running with no explicit bundler group
    # and/or no explicit environment - we have to reinvoke rake to
    # execute this task.
    def invoke_or_reboot_rake_task(task)
      if ENV['RAILS_GROUPS'].to_s.empty? || ENV['RAILS_ENV'].to_s.empty?
        ruby_rake_task task
      else
        Rake::Task[task].invoke
      end
    end

    desc &quot;Compile all the assets named in config.assets.precompile&quot;
    task :precompile do
      invoke_or_reboot_rake_task &quot;assets:precompile:all&quot;
    end

    namespace :precompile do
      def internal_precompile(digest=nil)
        unless Rails.application.config.assets.enabled
          warn &quot;Cannot precompile assets if sprockets is disabled. Please set config.assets.enabled to true&quot;
          exit
        end

        # Ensure that action view is loaded and the appropriate
        # sprockets hooks get executed
        _ = ActionView::Base

        config = Rails.application.config
        config.assets.compile = true
        config.assets.digest  = digest unless digest.nil?
        config.assets.digests = {}

        env      = Rails.application.assets
        target   = File.join(Rails.public_path, config.assets.prefix)
        compiler = Sprockets::StaticCompiler.new(env,
                                                 target,
                                                 config.assets.precompile,
                                                 :manifest_path =&gt; config.assets.manifest,
                                                 :digest =&gt; config.assets.digest,
                                                 :manifest =&gt; digest.nil?)
        compiler.compile
      end

      task :all do
        Rake::Task[&quot;assets:precompile:primary&quot;].invoke
        # We need to reinvoke in order to run the secondary digestless
        # asset compilation run - a fresh Sprockets environment is
        # required in order to compile digestless assets as the
        # environment has already cached the assets on the primary
        # run.
        ruby_rake_task(&quot;assets:precompile:nondigest&quot;, false) if Rails.application.config.assets.digest
      end

      task :primary =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        internal_precompile
      end

      task :nondigest =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        internal_precompile(false)
      end
    end

    desc &quot;Remove compiled assets&quot;
    task :clean do
      invoke_or_reboot_rake_task &quot;assets:clean:all&quot;
    end

    namespace :clean do
      task :all =&gt; [&quot;assets:environment&quot;, &quot;tmp:cache:clear&quot;] do
        config = Rails.application.config
        public_asset_path = File.join(Rails.public_path, config.assets.prefix)
        rm_rf public_asset_path, :secure =&gt; true
      end
    end

    task :environment do
      if Rails.application.config.assets.initialize_on_precompile
        Rake::Task[&quot;environment&quot;].invoke
      else
        Rails.application.initialize!(:assets)
        Sprockets::Bootstrap.new(Rails.application).run
      end
    end
  end
end
</code></pre>

<p>Now we can run <code>bundle exec rake profile:assets:precompile</code> to precompile our assets while outputting profiling info. Hopefully we can now finally figure out why this is always taking so long :).</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/regarding_if_statement_scope_in_ruby/">
        Regarding if statement scope in Ruby
      </a>
    </h1>

    <span class="post-date">Aug 31, 2013</span>

    


    <p>I recently learned that <code>if</code> statements in Ruby do not introduce scope. This means that you can write code like shown below and it&rsquo;ll work fine.</p>

<pre><code class="language-ruby"># perfectly valid Ruby code
if true
  foo = 5
end

puts foo
</code></pre>

<p>At first this seemed a bit weird to me. It wasn&rsquo;t until I read <a href="http://programmers.stackexchange.com/questions/58900/why-if-statements-do-not-introduce-scope-in-ruby-1-9">this</a> that I realized Ruby was even more versatile than I had first thought. As it turns out, it is this somewhat unconventional scoping rule that allows us to conditionally replace methods.</p>

<pre><code class="language-ruby">if foo == 5
  def some_method
    # do something
  end
else
  def some_method
    # do something else
  end
end
</code></pre>

<p>As well as conditionally modify implementations.</p>

<pre><code class="language-ruby">if foo == 5
  class someClass
    # ...
  end
else
  module someModule
    # ...
  end
end
</code></pre>

<p>And that&rsquo;s amazing!</p>

  </div>
  
  
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://vaneyckt.io/posts/ec2_instance_cost_comparison/">
        EC2 instance cost comparison
      </a>
    </h1>

    <span class="post-date">Aug 11, 2013</span>

    


    <p>Amazon&rsquo;s pricing scheme for its ec2 instances never struck me as particularly transparent. Until recently some of my DevOps colleagues even estimated cost by cross-referencing <a href="https://aws.amazon.com/ec2/instance-types">instance details</a> with <a href="http://aws.amazon.com/ec2/pricing">pricing information</a>. While this approach gives reasonable results for finding the cost of a given instance type, it doesn&rsquo;t lend itself very well to comparing prices across a range of different types.</p>

<p>When talking to an ex-colleague of mine about the hardships encountered for such a common task, he pointed me to <a href="http://www.ec2instances.info">this absolutely brilliant page</a>. It&rsquo;s so unbelievably simple and well thought-out that I can&rsquo;t help getting ever so slightly annoyed with whomever is in charge of communicating Amazon&rsquo;s pricing structure and the subpar job they are doing.</p>

  </div>
  
  
</div>


  </body>
</html>
