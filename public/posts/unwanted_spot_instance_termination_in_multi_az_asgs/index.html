<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta property="og:title" content="Unwanted spot instance termination in multi-AZ ASG" />
<meta property="og:description" content="" />

<meta property="og:type" content="article" />

<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://localhost:1313/posts/unwanted_spot_instance_termination_in_multi_az_asgs/" />


  <title> Unwanted spot instance termination in multi-AZ ASG  &middot; vaneyckt.io </title>

  

  <link rel="stylesheet" href="/css/monokai.css">
  <script src="/js/highlight.pack.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="stylesheet" href="http://localhost:1313//css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313//css/syntax.css">
  <link rel="stylesheet" href="http://localhost:1313//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="vaneyckt.io" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <link href='http://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-71853042-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1 class="brand"><a style="text-decoration:none" href="http://localhost:1313/">vaneyckt</a></h1>
      <p class="lead">
         notes to my future self 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://localhost:1313/">Home</a></li>
      <li><a href="http://localhost:1313//posts">Posts</a></li>
      <li><a href="http://localhost:1313//topics">Tags</a></li>
      
      <br/>
      
    </ul>
      
      
      
      <a href="https://github.com/vaneyckt"><i class="fa fa-github-square"></i></a>&nbsp;&nbsp;
      <a href="mailto:tomvaneyck@gmail.com"><i class="fa fa-envelope-square"></i></a>&nbsp;&nbsp;
      <a href="http://vaneyckt.io/index.xml"><i class="fa fa-rss-square"></i></a>&nbsp;&nbsp;
      

    <p class="footnote">powered by <a href="http://hugo.spf13.com">Hugo</a> <br/>
    &copy; 2015 Tom Van Eyck. All rights reserved.</p>
  </div>
</div>


  <div class="content container">
    <div class="post">
      <h1 class="post-title">Unwanted spot instance termination in multi-AZ ASG</h1>
      <span class="post-date">Jan 24, 2015</span>
      <p>Auto Scaling Groups are an AWS service that allows you to increase or decrease the number of EC2 instances within your application&rsquo;s architecture. Even better is that you can use Auto Scaling Groups in conjunction with AWS Spot Instances. This allows for large Auto Scaling Groups at low costs.</p>

<p>However, Spot Instances can be terminated by AWS at a moment&rsquo;s notice. Spot Instances are after all just unused AWS servers that are auctioned off for little money. As soon as someone out there wants to pay more than you do, you lose your Spot Instances.</p>

<p>Knowing all of this, I recently found myself looking into why AWS was terminating several of our Spot Instances every day. We were bidding 20% more than the average price, so it seemed unlikely that this was a monetary issue. Nevertheless, our Spot Instances kept disappearing.</p>

<p>Imagine my surprise upon learning this was caused by a combination of:</p>

<ul>
<li>our Auto Scaling Group spanning multiple Availability Zones</li>
<li>our scaling code making calls to <code>TerminateInstanceInAutoScalingGroup</code></li>
</ul>

<p>It turned out that:</p>

<ul>
<li>our scaling code was asking AWS to put 10 instances in our Auto Scaling Group</li>
<li>AWS obliged and put 5 instances in Availability Zone A and another 5 in Availability Zone B</li>
<li>some time later our scaling code would check in, and detect that 2 specific instances were no longer needed. It would then make a call <code>TerminateInstanceInAutoScalingGroup</code> to have these terminated.</li>
<li>if these 2 instances happened to be in the same Availability Zone, then one AZ would now have 3 instances, while the other would have 5</li>
<li>AWS would detect this AZ unbalance and trigger a rebalancing action. This rebalancing action would terminate one of the instances in the AZ with 5 instances, and spin up another instance in the AZ with 3 instances.</li>
</ul>

<p>So while this action ends up rebalancing the instances across the Availability Zones, it also ends up terminating a running instance. This was exactly what we were seeing.</p>

<p>This is the relevant entry from the AWS docs:</p>

<blockquote>
<p><strong>Instance Distribution and Balance across Multiple Zones</strong></p>

<p>Auto Scaling attempts to distribute instances evenly between the Availability Zones that are enabled for your Auto Scaling group. Auto Scaling attempts to launch new instances in the Availability Zone with the fewest instances. If the attempt fails, however, Auto Scaling will attempt to launch in other zones until it succeeds.</p>

<p>Certain operations and conditions can cause your Auto Scaling group to become unbalanced. Auto Scaling compensates by creating a rebalancing activity under any of the following conditions:</p>

<ul>
<li>You issue a request to change the Availability Zones for your group.</li>
<li>You call <code>TerminateInstanceInAutoScalingGroup</code>, which causes the group to become unbalanced.</li>
<li>An Availability Zone that previously had insufficient capacity recovers and has additional capacity available.</li>
</ul>

<p>Auto Scaling always launches new instances before attempting to terminate old ones, so a rebalancing activity will not compromise the performance or availability of your application.</p>

<p><strong>Multi-Zone Instance Counts when Approaching Capacity</strong></p>

<p>Because Auto Scaling always attempts to launch new instances before terminating old ones, being at or near the specified maximum capacity could impede or completely halt rebalancing activities. To avoid this problem, the system can temporarily exceed the specified maximum capacity of a group by a 10 percent margin during a rebalancing activity (or by a 1-instance margin, whichever is greater). The margin is extended only if the group is at or near maximum capacity and needs rebalancing, either as a result of user-requested rezoning or to compensate for zone availability issues. The extension lasts only as long as needed to rebalance the groupâ€”typically a few minutes.</p>
</blockquote>

<p>I&rsquo;m not sure about the correct way to get around this behaviour. In our particular case, we ended up restricting our Auto Scaling Group to just one Availability Zone. None of the work done by our Spot Instances is critical, so this worked for us. Going through the AWS Auto Scaling docs, it seems possible to disable the <code>AZRebalance</code> process. However, I have not tried this, so I cannot guarantee there won&rsquo;t be any unexpected side effects.</p>

    </div>
  </div>

<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
